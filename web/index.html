<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ðŸ§µ</text></svg>">
  <style>
  :root{
    --bg:#020617;
    --bg-soft:#0b1120;
    --card:#020617;
    --card-soft:#020617;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --ring:#1f2937;
    --accent:#22c55e;
    --accent-soft:rgba(34,197,94,0.14);
    --danger:#f97373;
  }

  *{
    box-sizing:border-box;
  }

  body{
    margin:0;
    min-height:100vh;
    background:
      radial-gradient(circle at top,rgba(34,197,94,0.18),transparent 60%),
      radial-gradient(circle at bottom,rgba(59,130,246,0.22),transparent 55%),
      #020617;
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif;
    display:flex;
    flex-direction:column;
  }

  .wrap{
    max-width:1180px;
    margin:24px auto 32px;
    padding:0 18px 24px;
  }

  h1{
    margin:0 0 6px;
    font-size:clamp(24px,4vw,30px);
    letter-spacing:0.02em;
    display:flex;
    align-items:center;
    gap:10px;
  }

  h1::before{
    content:"";
    width:32px;
    height:32px;
    border-radius:12px;
    background:
      radial-gradient(circle at 30% 20%,#22c55e,#16a34a 40%,#022c22 100%);
    box-shadow:0 0 0 1px rgba(15,23,42,0.8),0 18px 40px rgba(15,23,42,0.9);
    display:inline-block;
  }

  h2{
    margin:0 0 12px;
    font-size:17px;
    letter-spacing:0.03em;
    text-transform:uppercase;
    color:#cbd5f5;
  }

  .hint{
    color:var(--muted);
    font-size:12px;
  }

  .hint b{
    color:#e5e7eb;
    font-weight:600;
  }

  .grid{
    display:grid;
    grid-template-columns:1.25fr 1.1fr;
    gap:18px;
    margin-top:18px;
  }

  @media (max-width:1000px){
    .grid{
      grid-template-columns:1fr;
    }
  }

  .card{
    position:relative;
    background:
      radial-gradient(circle at top left,rgba(148,163,184,0.18),transparent 55%),
      radial-gradient(circle at bottom right,rgba(15,23,42,0.9),#020617 60%);
    border-radius:18px;
    padding:16px 16px 18px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
    overflow:hidden;
  }

  .card::before{
    content:"";
    position:absolute;
    inset:-120px;
    background:radial-gradient(circle at top,rgba(34,197,94,0.16),transparent 60%);
    opacity:0.7;
    pointer-events:none;
  }

  .card > *{
    position:relative;
    z-index:1;
  }

  .palette{
    display:flex;
    flex-direction:column;
    gap:6px;
    max-height:360px;
    overflow:auto;
    padding-right:4px;
    margin-top:4px;
  }

  .pill{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(51,65,85,0.9);
    background:rgba(15,23,42,0.94);
    cursor:pointer;
    font-size:13px;
    transition:
      border-color .12s ease,
      background .12s ease,
      transform .08s ease,
      box-shadow .12s ease;
  }

  .pill:hover{
    background:rgba(15,23,42,0.99);
    border-color:rgba(148,163,184,0.85);
    transform:translateY(-1px);
    box-shadow:0 8px 22px rgba(15,23,42,0.9);
  }

  .pill[aria-selected="true"]{
    border-color:var(--accent);
    box-shadow:
      0 0 0 1px rgba(34,197,94,0.5),
      0 14px 34px rgba(34,197,94,0.4);
    background:linear-gradient(135deg,rgba(34,197,94,0.22),rgba(15,23,42,0.98));
  }

  .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .dot{
    width:18px;
    height:18px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.9);
    box-shadow:
      0 0 0 1px rgba(15,23,42,0.6),
      0 0 0 2px rgba(15,23,42,0.4),
      0 0 8px rgba(15,23,42,0.9);
    background:#6b7280;
    position:relative;
    overflow:hidden;
    flex-shrink:0;
  }

  .dot.transparent{
    background:repeating-conic-gradient(#475569 0 25%,#1e293b 0 50%) 50%/12px 12px;
  }

  .dot.transparent::after{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(135deg,rgba(15,23,42,0.85),transparent);
  }

  .title{
    font-weight:600;
    font-size:13px;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }

  .sub{
    font-size:11px;
    color:var(--muted);
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }

  .price{
    font-weight:600;
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    flex-shrink:0;
  }

  .row{
    display:flex;
    gap:10px;
    align-items:flex-end;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .row label{
    flex:1 1 150px;
  }

  input[type="file"],
  input[type="text"],
  select,
  button{
    border-radius:999px;
    border:1px solid rgba(51,65,85,0.9);
    background:#020617;
    color:var(--text);
    padding:8px 11px;
    font-size:13px;
    outline:none;
    transition:
      border-color .15s ease,
      box-shadow .15s ease,
      background .15s ease,
      transform .08s ease;
  }

  input[type="file"]{
    padding:8px;
    border-radius:10px;
    background:#020617;
  }

  input::placeholder{
    color:rgba(148,163,184,0.8);
  }

  input:focus,
  select:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(34,197,94,0.4);
    background:#020617;
  }

  button{
    cursor:pointer;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:#ecfdf5;
    font-weight:500;
    border:none;
    box-shadow:0 14px 30px rgba(22,163,74,0.45);
  }

  button:hover{
    transform:translateY(-1px);
    box-shadow:0 18px 42px rgba(22,163,74,0.55);
    filter:brightness(1.03);
  }

  button:active{
    transform:translateY(0);
    box-shadow:0 10px 24px rgba(22,163,74,0.5);
    filter:brightness(0.98);
  }

  .viewer{
    height:320px;
    border-radius:16px;
    border:1px dashed rgba(148,163,184,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    font-size:13px;
    background:radial-gradient(circle at top,rgba(15,23,42,0.9),#020617 70%);
    margin-bottom:8px;
    padding:8px;
    text-align:center;
  }

  .viewer.drag{
    border-color:var(--accent);
    color:var(--accent);
    box-shadow:0 0 0 1px rgba(34,197,94,0.5);
  }

  .out{
    margin-top:16px;
    font-size:15px;
    line-height:1.5;
    background:#020617;
    padding:12px 14px;
    border-radius:14px;
    color:var(--text);
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 12px 28px rgba(15,23,42,0.85);
    white-space:pre-wrap;
  }

  .out b{
    color:var(--accent);
    font-size:18px;
  }

  .est{
    display:grid;
    grid-template-columns:repeat(6,minmax(120px,1fr));
    gap:10px;
    margin-top:10px;
  }

  @media (max-width:1100px){
    .est{
      grid-template-columns:repeat(3,1fr);
    }
  }

  .advanced{
    display:none;
  }

  #btnWizard{
    position:fixed;
    top:18px;
    right:18px;
    padding:7px 12px;
    font-size:13px;
    z-index:1000;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.92);
    color:var(--text);
    box-shadow:0 10px 24px rgba(15,23,42,0.9);
  }

  #btnWizard:hover{
    border-color:var(--accent);
    color:#bbf7d0;
  }

  .wizard-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.88);
    z-index:999;
    display:none;
    align-items:center;
    justify-content:center;
  }

  .wizard-box{
    max-width:600px;
    width:100%;
    margin:0 16px;
    background:#020617;
    border-radius:18px;
    padding:20px 18px 16px;
    border:1px solid rgba(148,163,184,0.7);
    box-shadow:0 24px 60px rgba(0,0,0,0.9);
  }

  .wizard-box h2{
    margin-top:0;
    margin-bottom:8px;
    font-size:18px;
  }

  .wizard-box p,
  .wizard-box li{
    font-size:13px;
    color:var(--muted);
  }

  .wizard-box button{
    background:transparent;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    color:var(--text);
    padding:6px 10px;
    box-shadow:none;
  }

  .wizard-box button:hover{
    border-color:var(--accent);
    color:#bbf7d0;
    box-shadow:0 10px 24px rgba(15,23,42,0.9);
  }

</style>


  <!-- Import map per Three r160+ (DEVE stare nel <head> prima dei moduli) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- Collante JSM â†’ window.THREE -->
  <script type="module">
    import * as THREE_NS from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { ThreeMFLoader } from 'three/addons/loaders/3MFLoader.js';
    window.THREE = { ...THREE_NS, OrbitControls, STLLoader, OBJLoader, ThreeMFLoader };
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Dati e prezzi da Spoolman (â‚¬/kg). Costo macchina fisso lato server. La stima usa CuraEngine.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <input id="paletteFilter" type="text" placeholder="Filtra per materiale o colore" style="margin-bottom:8px; width:100%" oninput="filterPalette()" />
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce: <b>Materiale</b> â€” <span class="sub">Nome colore</span> â€” <b>â‚¬/kg</b>. Aggiornamento ogni 60 s.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">Trascina qui un file o caricalo dal pulsante sotto.</div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>File & Stima</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip,.step,.stp" multiple />
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="flex:1;min-width:260px" />
        <button id="btnFetch">Da URL</button>
        <button id="btnDelete" style="margin-left:8px">Elimina</button>
      </div>

      <div class="est">
        <label class="advanced">Layer
          <select id="layer_h">
            <option value="0.20">0.20 mm</option>
            <option value="0.16">0.16 mm</option>
            <option value="0.12">0.12 mm</option>
            <option value="0.28">0.28 mm</option>
          </select>
        </label>
        <label class="advanced">Infill
          <select id="infill">
            <option value="15">15%</option>
            <option value="5">5%</option>
            <option value="20">20%</option>
            <option value="40">40%</option>
          </select>
        </label>
        <label class="advanced">Nozzle
          <select id="nozzle">
            <option value="0.4">0.4 mm</option>
            <option value="0.6">0.6 mm</option>
            <option value="0.2">0.2 mm</option>
          </select>
        </label>
        <label class="advanced">Print speed
          <select id="print_speed">
            <option value="40">40 mm/s</option>
            <option value="60" selected>60 mm/s</option>
            <option value="80">80 mm/s</option>
            <option value="100">100 mm/s</option>
            <option value="160">160 mm/s</option>
            <option value="200">200 mm/s</option>
            <option value="250">250 mm/s</option>
          </select>
        </label>
        <label class="advanced">Travel speed
          <select id="travel_speed">
            <option value="100">100 mm/s</option>
            <option value="150" selected>150 mm/s</option>
            <option value="200">200 mm/s</option>
            <option value="300">300 mm/s</option>
            <option value="500">500 mm/s</option>
          </select>
        </label>
        <label>Preset
          <select id="preset">
            <option value="x1c_standard_020" selected>Standard</option>
            <optgroup label="Bambu X1C">
              <option value="x1c_standard_020">0.20 Standard</option>
              <option value="x1c_quality_016">0.16 Quality</option>
              <option value="x1c_fine_012">0.12 Fine</option>
              <option value="x1c_draft_028">0.28 Draft</option>
              <option value="x1c_strength_020">0.20 Strength</option>
              <option value="x1c_lightning_020">0.20 Lightning</option>
              <option value="x1c_ultrafine_008">0.08 Ultra Fine</option>
            </optgroup>
          </select>
        </label>
        <div style="display:flex;align-items:end">
          <button id="btnEstimate">Stima</button>
        </div>
      </div>

      <div id="out" class="out"></div>
    </div>
  </div>

  <button id="btnWizard" title="Apri guida" style="position:fixed;top:16px;right:16px;background:var(--card);border:1px solid var(--ring);color:var(--accent);padding:8px 12px;border-radius:12px;font-size:14px;z-index:1000;cursor:pointer">Guida</button>

  <div id="wizard" class="wizard-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;">
    <div class="wizard-box" style="max-width:600px;margin:10% auto;background:var(--card);color:var(--text);padding:24px;border-radius:16px;box-shadow:0 0 12px rgba(0,0,0,0.5);">
      <h2 style="margin-top:0">Benvenuto!</h2>
      <p>Questa guida ti accompagna ai passi per ottenere una stima:</p>
      <ol style="line-height:1.6">
        <li><b>Scegli un materiale</b> dalla palette.</li>
        <li><b>Carica il modello</b> (STL/3MF/OBJ o URL).</li>
        <li><b>Scegli il preset</b> (X1C di default).</li>
        <li><b>Premi Stima</b> per G-code, tempi e costi.</li>
      </ol>
      <p style="margin-top:20px;text-align:right"><button id="wizardClose" style="background:var(--accent);color:#000;padding:8px 16px;border:none;border-radius:10px;cursor:pointer">Chiudi</button></p>
    </div>
  </div>

  <script>
    // ---------- util colore ----------
    function hexNorm(h){
      if(!h) return '#777777';
      let s=String(h).trim();
      if(!s.startsWith('#')) s='#'+s;
      return s.toUpperCase();
    }
    // --- Mappa esplicita HEX -> nome colore (fonte: schede produttori / banche colori online)
    // Nota: prevale su classificazione HSV.
    const KNOWN_HEX_LABELS = {
      '#FFFFFF':'Bianco',
      '#000000':'Nero',
      '#020000':'Nero',
      '#A6A9AA':'Grigio',
      '#E4BD68':'Oro',        // soft gold (â‰ˆ41Â° HSV) â€” vedi colorhexa/spektran
      '#FF9016':'Arancione', // vivid orange
      '#F4EE2A':'Giallo',    // bright yellow
      '#0A2989':'Blu',       // Bambu PLA Blue
      '#5E43B7':'Viola',     // purple
      '#00AE42':'Verde',
      '#EC008C':'Rosa',      // magenta/fucsia â†’ rosa
      '#F5547C':'Rosa',      // hot pink
      '#C12E1F':'Rosso',
      '#9D432C':'Marrone',   // burnt sienna/brown
      '#F7E6DE':'Bianco'     // quasi bianco caldo (pastello)
    };

    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||"");
      return m ? {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)} : {r:119,g:119,b:119};
    }
    function rgbToHsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      const d = max-min;
      let h=0;
      if(d!==0){
        switch(max){
          case r: h = ((g-b)/d + (g<b?6:0)); break;
          case g: h = ((b-r)/d + 2); break;
          case b: h = ((r-g)/d + 4); break;
        }
        h*=60;
      }
      const s = max===0?0:d/max;
      const v = max;
      return {h,s,v};
    }
    function near(a,b,eps){ return Math.abs(a-b)<=eps; }

    // nome colore coerente con HSV + regole
    function nameFromHex(hex, isTransparent){
      hex = hexNorm(hex);
      if(isTransparent) return 'Trasparente';
      const {r,g,b}=hexToRgb(hex);
      const {h,s,v}=rgbToHsv(r,g,b); // h in [0,360), s,v in [0,1]

      // grigi / bianchi / neri
      if(s < 0.10){
        if(v > 0.90) return 'Bianco';
        if(v < 0.15) return 'Nero';
        return 'Grigio';
      }

      // marrone (arancio scuro)
      if(h>=15 && h<40 && v<0.60) return 'Marrone';

      // oro dedicato
      if(h>=40 && h<55 && s>0.40 && v>0.60) return 'Oro';

      // fasce principali
      if(h<15 || h>=345) return 'Rosso';
      if(h>=15 && h<40)  return 'Arancione';
      if(h>=55 && h<75)  return 'Giallo';
      if(h>=75 && h<160) return 'Verde';
      if(h>=160 && h<190) return 'Ciano';
      if(h>=190 && h<255) return 'Blu';
      if(h>=255 && h<295) return 'Viola';
      if(h>=295 && h<345) return 'Rosa';
      return 'N/D';
    }

    // coerenza: se il nome fornito Ã¨ palesemente sbagliato rispetto all'hex, ricalcolo
    function coherentName(hex, given, isTransparent){
      const auto = nameFromHex(hex, isTransparent);
      if(!given) return auto;
      const g = String(given).trim().toLowerCase();
      const a = String(auto).toLowerCase();
      // se sono equivalenti o sinonimi, tiene quello di Spoolman
      const syn = {
        'fucsia':'fucsia','magenta':'magenta','azzurro':'blu chiaro','gold':'oro','transparent':'trasparente','translucent':'trasparente'
      };
      const g2 = syn[g] || g;
      if(g2===a) return given;

      // se differenza macroscopica (es. g=bianco ma hex non Ã¨ vicino al bianco) â†’ usa auto
      const hx = hexNorm(hex);
      if(g.includes('bianco') && hx!=='#FFFFFF') return auto;
      if(g.includes('trasp')) return 'Trasparente';
      // preferisci auto se dato Ã¨ in un altro cluster (es. blu vs viola, arancione vs oro)
      return auto;
    }

    // ---------- stato ----------
    let selectedKey = null;
    let currentViewerUrl = null;
    let selectedMachine = "generic";
    let inventoryItems = [];
    const REFRESH_MS = 60000; // 60 s

    // ---------- palette ----------
    async function loadPalette(){
      const res = await fetch('/inventory?nocache='+Date.now());
      const data = await res.json();
      const raw = Array.isArray(data.items) ? data.items : [];

      inventoryItems = raw.map((it,i)=>{
        // campi robusti dal backend (color_hex, color_name giÃ  normalizzati lato API)
        const hex = hexNorm(it.color_hex || it.hex || '#777777');
        const is_transparent = Boolean(it.is_transparent) || /(transpar|traspar)/i.test(String(it.color_name||''));

        // 1) fidati del nome che arriva dal backend (colors.json / Spoolman)
        let color_name = it.color_name || it.name;

        // 2) fallback solo se manca del tutto
        if(!color_name){
          color_name = is_transparent ? 'Trasparente' : nameFromHex(hex, is_transparent);
        }

        const key = it.key || `${(it.material||'mat')}_${hex}_${i}`;
        return { ...it, color: hex, key, is_transparent, color_name };
      });

      renderPalette(inventoryItems);
    }

    function filterPalette(){
      const term = (document.getElementById('paletteFilter').value || '').trim().toLowerCase();
      if(!term){ renderPalette(inventoryItems); return; }
      const filtered = inventoryItems.filter(it => {
        const mat = (it.material || '').toLowerCase();
        const colorName = (it.color_name || '').toLowerCase();
        return mat.includes(term) || colorName.includes(term);
      });
      renderPalette(filtered);
    }

    // ---------- preset handling ----------
    const PRESETS = {
      "": { machine: "generic", layer_h: 0.20, infill: 15, nozzle: 0.4, print_speed: 60, travel_speed: 150 },
      "x1c_standard_020": { machine: "bambu_x1c", layer_h: 0.20, infill: 15, nozzle: 0.4, print_speed: 200, travel_speed: 500 },
      "x1c_quality_016":  { machine: "bambu_x1c", layer_h: 0.16, infill: 15, nozzle: 0.4, print_speed: 200, travel_speed: 500 },
      "x1c_fine_012":     { machine: "bambu_x1c", layer_h: 0.12, infill: 20, nozzle: 0.4, print_speed: 160, travel_speed: 500 },
      "x1c_draft_028":    { machine: "bambu_x1c", layer_h: 0.28, infill: 15, nozzle: 0.4, print_speed: 250, travel_speed: 500 },
      "x1c_strength_020": { machine: "bambu_x1c", layer_h: 0.20, infill: 50, nozzle: 0.4, print_speed: 180, travel_speed: 500 },
      "x1c_lightning_020":{ machine: "bambu_x1c", layer_h: 0.20, infill: 10, nozzle: 0.4, print_speed: 300, travel_speed: 500 },
      "x1c_ultrafine_008":{ machine: "bambu_x1c", layer_h: 0.08, infill: 20, nozzle: 0.4, print_speed: 160, travel_speed: 500 }
    };

    function applyPreset(key){
      const p = PRESETS[key] || PRESETS[""];
      selectedMachine = p.machine || "generic";
      if(p.layer_h!=null)      document.getElementById('layer_h').value = p.layer_h.toFixed(2);
      if(p.infill!=null)       document.getElementById('infill').value   = String(p.infill);
      if(p.nozzle!=null)       document.getElementById('nozzle').value   = p.nozzle.toFixed(1);
      if(p.print_speed!=null)  document.getElementById('print_speed').value = String(p.print_speed);
      if(p.travel_speed!=null) document.getElementById('travel_speed').value = String(p.travel_speed);
    }

    function renderPalette(items){
      const box = document.getElementById('palette');
      box.innerHTML = '';
      items
        .sort((a,b)=> (a.material||'').localeCompare(b.material||'') || (a.color_name||'').localeCompare(b.color_name||'') )
        .forEach(it=>{
          const hex = hexNorm(it.color);
          const price = (it.price_per_kg!=null) ? `${Number(it.price_per_kg).toFixed(2)} ${it.currency||'EUR'}/kg` : 'n/d';
          const colorName = it.color_name || nameFromHex(hex, it.is_transparent);

          const row = document.createElement('div');
          row.className='pill';
          row.setAttribute('role','option');
          row.setAttribute('aria-label', `${it.material}, ${colorName}, ${price}`);
          row.setAttribute('aria-selected', selectedKey===it.key ? 'true' : 'false');
          row.onclick = () => {
            selectedKey = it.key;
            [...box.children].forEach(c => c.setAttribute('aria-selected', 'false'));
            row.setAttribute('aria-selected', 'true');
            if (currentViewerUrl) setTimeout(() => { showViewer(currentViewerUrl, window.__lastModelName || null); }, 0);
          };

          const left = document.createElement('div'); left.className='left';
          const dot = document.createElement('span'); dot.className='dot' + (it.is_transparent ? ' transparent' : '');
          if(!it.is_transparent){ dot.style.backgroundColor = hex; }
          dot.title = colorName; dot.setAttribute('aria-hidden','true');

          const col = document.createElement('div');
          const t1 = document.createElement('div'); t1.className='title'; t1.textContent = it.material || 'n/d';
          const t2 = document.createElement('div'); t2.className='sub'; t2.textContent = colorName;
          col.appendChild(t1); col.appendChild(t2);

          left.appendChild(dot); left.appendChild(col);
          const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = price;

          row.appendChild(left); row.appendChild(priceEl);
          box.appendChild(row);
        });
    }

    // ---------- upload / fetch ----------
    async function uploadFileOrBlob(file){
      const v = document.getElementById('viewer');
      if(v){ v.classList.remove('drag'); v.textContent = 'Caricamento modelloâ€¦'; }
      const fd = new FormData(); fd.append('file', file);
      const r = await fetch('/upload_model', {method:'POST', body: fd});
      if(!r.ok){ alert('Upload fallito'); return; }
      const j = await r.json();
      showViewer(j.viewer_url, j.filename);
    }

    async function fetchFromUrl(){
      const url = document.getElementById('url').value.trim();
      if(!url){ alert('Inserisci una URL'); return; }
      const v = document.getElementById('viewer');
      if(v){ v.classList.remove('drag'); v.textContent = 'Caricamento modello da URL...'; }
      const r = await fetch('/fetch_model', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url})});
      const j = await r.json();
      if(j.viewer_url){ showViewer(j.viewer_url, j.filename); } else { alert('Nessun modello trovato'); }
    }

    const viewer = document.getElementById('viewer');
    viewer.addEventListener('dragenter', e => { e.preventDefault(); viewer.classList.add('drag'); });
    viewer.addEventListener('dragover',  e => { e.preventDefault(); e.dataTransfer.dropEffect='copy'; viewer.classList.add('drag'); });
    viewer.addEventListener('dragleave', e => { if(!viewer.contains(e.relatedTarget)) viewer.classList.remove('drag'); });
    viewer.addEventListener('drop',      e => {
      e.preventDefault(); viewer.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){ uploadFileOrBlob(f); }
    });

    const fileInput = document.getElementById('file');
    fileInput.addEventListener('change', () => {
      const files = fileInput.files; if(!files || !files.length) return;
      for(const f of files){ if(f) uploadFileOrBlob(f); }
      fileInput.value = '';
    });

    const btnDelete = document.getElementById('btnDelete');
    btnDelete.addEventListener('click', () => {
      const v = document.getElementById('viewer');
      v.innerHTML = 'Trascina qui un file o caricalo dal pulsante sotto.';
      v.classList.remove('drag');
      window.__lastModelName = null;
      currentViewerUrl = null;
      fileInput.value = '';
      document.getElementById('out').innerHTML = '';
    });

    /**
     * Viewer 3D
     */
    function showViewer(path, name){
      currentViewerUrl = path;
      window.__lastModelName = name;
      const viewer = document.getElementById('viewer');
      viewer.innerHTML = '';
      viewer.classList.remove('drag');

      const THREE = window.THREE;
      if(!THREE || !THREE.WebGLRenderer){
        const enc = encodeURI(path);
        viewer.innerHTML = `<a href="${enc}" target="_blank" style="color:var(--accent)">${enc}</a>`;
        document.getElementById('out').innerHTML = '';
        return;
      }

      const extMatch = path.split('.').pop().toLowerCase().split('?')[0];
      const safePath = encodeURI(path);
      let loader;
      if(extMatch === 'stl' && THREE.STLLoader){
        loader = new THREE.STLLoader();
      } else if(extMatch === 'obj' && THREE.OBJLoader){
        loader = new THREE.OBJLoader();
      } else if(extMatch === '3mf' && THREE.ThreeMFLoader){
        loader = new THREE.ThreeMFLoader();
      } else {
        viewer.innerHTML = `<a href="${path}" target="_blank" style="color:var(--accent)">${path}</a>`;
        document.getElementById('out').innerHTML = '';
        return;
      }

      const width = viewer.clientWidth;
      const height = viewer.clientHeight;
      const canvas = document.createElement('div');
      canvas.style.width = '100%';
      canvas.style.height = height + 'px';
      viewer.appendChild(canvas);

      const scene = new THREE.Scene();
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#0f172a';
      scene.background = new THREE.Color(bg);
      const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(width, height);
      canvas.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;

      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);
      const directional = new THREE.DirectionalLight(0xffffff, 0.8);
      directional.position.set(3, 10, 5);
      scene.add(directional);

      loader.load(safePath, (result) => {
        let object;
        const sel = inventoryItems.find(x => x.key === selectedKey) || {};
        let hex = hexNorm(sel.color || '#AAAAAA');
        const col = new THREE.Color(hex);
        const isTransp = Boolean(sel.is_transparent);

        if(extMatch === 'stl'){
          const material = new THREE.MeshStandardMaterial({
            color: col, transparent: isTransp, opacity: isTransp ? 0.6 : 1.0,
            metalness: 0.1, roughness: 0.8
          });
          object = new THREE.Mesh(result, material);
        } else {
          object = result;
          object.traverse((child) => {
            if(child.isMesh){
              let mat = child.material;
              if(Array.isArray(mat)) mat = mat.map(m => m.clone());
              else if(mat) mat = mat.clone();
              if(mat){
                const apply = (m)=>{ m.color = col.clone(); m.transparent=isTransp; m.opacity=isTransp?0.6:1.0; };
                if(Array.isArray(mat)) mat.forEach(apply); else apply(mat);
                child.material = mat;
              }
            }
          });
        }
        scene.add(object);

        const box = new THREE.Box3().setFromObject(object);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
        camera.position.set(center.x, center.y, center.z + cameraZ * 1.5);
        camera.near = Math.max(0.001, maxDim / 100);
        camera.far  = Math.max(10,    maxDim * 100);
        camera.updateProjectionMatrix();
        controls.target.copy(center);
        controls.update();

        (function animate(){
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        })();

      }, undefined, (error) => {
        // Fallback STL da 3MF
        if (extMatch === '3mf') {
          let stlPath = path.replace(/\.3mf(\?.*)?$/i, '.stl$1');
          const bust = (stlPath.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
          stlPath += bust;

          fetch(stlPath, { method: 'GET' })
            .then(async (r) => {
              if (!r.ok) throw new Error('STL non trovato: ' + r.status);
              const ct = r.headers.get('content-type') || '';
              const buf = await r.arrayBuffer();
              if (ct.includes('text/html') || buf.byteLength < 84) {
                throw new Error('STL non valido o troppo corto (' + buf.byteLength + ' B)');
              }
              const stlLoader = new THREE.STLLoader();
              const geom = stlLoader.parse(buf);

              const sel = inventoryItems.find(x => x.key === selectedKey) || {};
              let hex = hexNorm(sel.color || '#AAAAAA');
              const col = new THREE.Color(hex);
              const isTransp = Boolean(sel.is_transparent);
              const material = new THREE.MeshStandardMaterial({
                color: col, transparent: isTransp, opacity: isTransp ? 0.6 : 1.0,
                metalness: 0.1, roughness: 0.8
              });
              const object = new THREE.Mesh(geom, material);
              scene.add(object);

              const box = new THREE.Box3().setFromObject(object);
              const size = box.getSize(new THREE.Vector3());
              const center = box.getCenter(new THREE.Vector3());
              const maxDim = Math.max(size.x, size.y, size.z) || 1;
              const fov = camera.fov * (Math.PI / 180);
              const cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
              camera.position.set(center.x, center.y, center.z + cameraZ * 1.5);
              camera.near = Math.max(0.001, maxDim / 100);
              camera.far  = Math.max(10,    maxDim * 100);
              camera.updateProjectionMatrix();
              controls.target.copy(center);
              controls.update();
            })
            .catch(() => {
              const link = encodeURI(path);
              viewer.innerHTML = `<a href="${link}" target="_blank" style="color:var(--accent)">${link}</a>`;
            });
        } else {
          const link = encodeURI(path);
          viewer.innerHTML = `<a href="${link}" target="_blank" style="color:var(--accent)">${link}</a>`;
        }
      });

      document.getElementById('out').innerHTML = '';
    }

    async function estimate(){
      if(!currentViewerUrl){ alert('Carica prima un modello'); return; }
      if(!selectedKey){ alert('Seleziona un materiale dalla palette'); return; }
      const estimateBtn = document.getElementById('btnEstimate');
      if(estimateBtn){ estimateBtn.disabled = true; estimateBtn.textContent = 'Calcolo...'; }
      const outEl = document.getElementById('out');
      if(outEl){ outEl.innerHTML = 'Calcolo in corso...'; }

      const payload = {
        viewer_url: currentViewerUrl,
        inventory_key: selectedKey,
        machine: selectedMachine,
        settings: {
          machine: selectedMachine,
          layer_h: parseFloat(document.getElementById('layer_h').value || '0.2'),
          infill: parseFloat(document.getElementById('infill').value || '15'),
          nozzle: parseFloat(document.getElementById('nozzle').value || '0.4'),
          print_speed: parseFloat(document.getElementById('print_speed').value || '60'),
          travel_speed: parseFloat(document.getElementById('travel_speed').value || '150')
        }
      };
      const r = await fetch('/slice/estimate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const j = await r.json();
      if(!r.ok){
        alert(j.detail || 'Errore stima');
        if(estimateBtn){ estimateBtn.disabled = false; estimateBtn.textContent = 'Stima'; }
        return;
      }
      const tmin = Math.round(j.time_s/60);
      document.getElementById('out').innerHTML = `
        Tempo: <b>${tmin} min</b> â€” Filamento: <b>${j.filament_g} g</b><br>
        Costo filamento: <b>${j.cost_filament} ${j.currency}</b> â€” Costo macchina: <b>${j.cost_machine} ${j.currency}</b><br>
        Totale: <b>${j.total} ${j.currency}</b> â€” <a href="${j.gcode_url}" target="_blank" style="color:var(--accent)">Scarica G-code</a>
      `;
      if(estimateBtn){ estimateBtn.disabled = false; estimateBtn.textContent = 'Stima'; }
    }

    document.getElementById('btnFetch').onclick  = fetchFromUrl;
    document.getElementById('btnEstimate').onclick  = estimate;

    const presetSel = document.getElementById('preset');
    if(presetSel){
      presetSel.onchange = () => applyPreset(presetSel.value);
      if (!selectedMachine || selectedMachine === 'generic') {
        presetSel.value = 'x1c_standard_020';
        applyPreset('x1c_standard_020');
      }
    }
    loadPalette();
    setInterval(loadPalette, REFRESH_MS);

    const wizardBtn = document.getElementById('btnWizard');
    const wizardOverlay = document.getElementById('wizard');
    const wizardClose = document.getElementById('wizardClose');
    if(wizardBtn && wizardOverlay){ wizardBtn.onclick = () => { wizardOverlay.style.display = 'block'; }; }
    if(wizardClose){ wizardClose.onclick = () => { wizardOverlay.style.display = 'none'; }; }
  </script>
</body>
</html>
