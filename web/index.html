<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Stima stampa 3D</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-soft:rgba(34,197,94,0.1);--danger:#f97373}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1e293b 0,#020617 55%,#000 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:24px 12px 40px;
    }
    h1{
      font-size:clamp(24px,4vw,32px);
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    h1 span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;
      height:36px;
      border-radius:12px;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a 40%,#022c22 100%);
      box-shadow:0 0 0 1px rgba(15,23,42,0.6),0 18px 30px rgba(15,23,42,0.8);
    }
    h1 span.logo svg{
      width:24px;height:24px;
      filter:drop-shadow(0 0 3px rgba(15,23,42,0.9));
    }
    h1 small{
      display:block;
      font-size:12px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.09em;
      color:var(--muted);
    }
    .subtitle{
      margin-bottom:18px;
      font-size:13px;
      color:var(--muted);
      max-width:620px;
    }
    .subtitle strong{
      color:#e5e7eb;
      font-weight:600;
    }
    .layout{
      width:100%;
      max-width:1120px;
      display:grid;
      grid-template-columns:1.4fr 1fr;
      gap:16px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
      }
    }
    .card{
      background:radial-gradient(circle at top left,rgba(148,163,184,0.18),transparent 50%),radial-gradient(circle at bottom right,rgba(37,99,235,0.32),transparent 55%),var(--card);
      border-radius:18px;
      padding:16px 16px 18px;
      position:relative;
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.25);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:radial-gradient(circle at top,rgba(34,197,94,0.08),transparent 60%);
      opacity:0.8;
      pointer-events:none;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
      position:relative;
      z-index:1;
    }
    .card-header h2{
      margin:0;
      font-size:18px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card-header h2 span.icon{
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a 40%,#064e3b 100%);
      box-shadow:0 0 0 1px rgba(15,23,42,0.7);
    }
    .card-header h2 span.icon svg{
      width:13px;height:13px;
    }
    .card-header .hint{
      font-size:11px;
      color:var(--muted);
    }
    .card-body{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }
    .field-row > label{
      flex:1 1 160px;
    }
    .field-row.actions{
      justify-content:space-between;
      align-items:center;
      margin-top:2px;
    }
    input[type="file"],
    select,
    input[type="number"],
    input[type="text"]{
      width:100%;
      font-size:13px;
      padding:6px 9px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.88);
      color:var(--text);
      outline:none;
      transition:border-color .15s ease,box-shadow .15s ease,background .15s ease;
    }
    input[type="file"]{
      padding:6px;
    }
    input::placeholder{
      color:rgba(148,163,184,0.7);
    }
    input:focus,
    select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,0.3);
      background:rgba(15,23,42,0.96);
    }
    select{
      cursor:pointer;
    }
    .help{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:7px 9px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(51,65,85,0.9);
      margin-bottom:6px;
      cursor:pointer;
      transition:background .12s ease,border-color .12s ease,transform .08s ease;
    }
    .pill:hover{
      background:rgba(15,23,42,0.98);
      border-color:rgba(148,163,184,0.9);
      transform:translateY(-1px);
    }
    .pill.selected{
      background:linear-gradient(135deg,rgba(34,197,94,0.16),rgba(15,23,42,0.95));
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,0.5);
    }
    .pill .left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill .title{
      font-size:13px;
      font-weight:500;
    }
    .pill .sub{
      font-size:11px;
      color:var(--muted);
    }
    .pill .price{
      font-size:11px;
      color:var(--muted);
      margin-right:6px;
    }
    .dot{
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.9);
      box-shadow:0 0 0 1px rgba(15,23,42,0.5),0 0 0 2px rgba(15,23,42,0.3),0 0 8px rgba(15,23,42,0.9);
      background:#6b7280;
      position:relative;
      overflow:hidden;
    }
    .dot.transparent{
      background:repeating-conic-gradient(#475569 0 25%,#1e293b 0 50%) 50%/12px 12px;
    }
    .dot.transparent::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(15,23,42,0.8),transparent);
    }
    button{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#ecfdf5;
      box-shadow:0 14px 30px rgba(22,163,74,0.4);
      transition:transform .08s ease,box-shadow .08s ease,filter .08s ease;
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(22,163,74,0.5);
      filter:brightness(1.04);
    }
    button:active{
      transform:translateY(0);
      box-shadow:0 8px 20px rgba(22,163,74,0.5);
      filter:brightness(0.97);
    }
    button.secondary{
      background:transparent;
      border:1px solid rgba(148,163,184,0.6);
      color:var(--muted);
      box-shadow:none;
    }
    button.secondary:hover{
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;
      transform:translateY(-1px);
    }
    button.secondary:active{
      transform:translateY(0);
    }
    button svg{
      width:14px;
      height:14px;
    }
    .out{
      margin-top:10px;
      font-size:13px;
      background:rgba(15,23,42,0.9);
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      padding:10px 12px;
      max-height:260px;
      overflow:auto;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .presets-row{
      display:flex;
      align-items:flex-end;
      gap:8px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .presets-row > label{
      flex:1 1 180px;
      margin:0;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      background:rgba(148,163,184,0.2);
      color:var(--muted);
    }
    .badge span.dot-small{
      width:6px;height:6px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a);
    }
    .info-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .info-line span.right{
      color:#e5e7eb;
      font-weight:500;
    }

    .viewer-wrapper{
      position:relative;
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.25);
      overflow:hidden;
      background:radial-gradient(circle at top,rgba(15,23,42,0.6),#020617 60%);
      min-height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .viewer-wrapper canvas{
      width:100%!important;
      height:260px!important;
      display:block;
    }
    .viewer-overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(circle at top,rgba(15,23,42,0.2),transparent 60%);
      mix-blend-mode:soft-light;
    }
    .no-viewer{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      padding:16px;
    }

    .footer{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .footer span.tag{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
    }

    .wizard-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.86);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
    }
    .wizard{
      max-width:520px;
      width:100%;
      background:radial-gradient(circle at top,rgba(34,197,94,0.08),transparent 60%),#020617;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 24px 80px rgba(15,23,42,0.95);
      padding:16px 18px 14px;
      position:relative;
    }
    .wizard h3{
      margin:0 0 6px;
      font-size:17px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .wizard h3 span.icon{
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a 40%,#064e3b 100%);
      box-shadow:0 0 0 1px rgba(15,23,42,0.7);
    }
    .wizard h3 span.icon svg{
      width:13px;height:13px;
    }
    .wizard p{
      margin:0 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    .wizard ol{
      margin:8px 0 0;
      padding-left:18px;
      font-size:12px;
      color:var(--muted);
    }
    .wizard li{
      margin-bottom:4px;
    }
    .wizard-close{
      position:absolute;
      top:10px;
      right:12px;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      background:transparent;
      border:none;
      padding:3px 6px;
      border-radius:999px;
    }
    .wizard-close:hover{
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
    }
    .wizard-footer{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .wizard-footer .badge{
      background:rgba(34,197,94,0.08);
      color:#bbf7d0;
      border:1px solid rgba(34,197,94,0.5);
    }
  </style>
</head>
<body>
  <h1>
    <span class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M5 17.5C5 17.5 7 15 7 9.5C7 7.015 8.79 5 11 5C13.21 5 15 7.015 15 9.5C15 15 17 17.5 17 17.5H5Z" stroke="#ecfdf5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M9.5 11C9.5 9.619 10.395 8.5 11.5 8.5C12.605 8.5 13.5 9.619 13.5 11" stroke="#bbf7d0" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M7 17.5C7 17.5 8 19 11.5 19C15 19 16 17.5 16 17.5" stroke="#bbf7d0" stroke-width="1.3" stroke-linecap="round"/>
      </svg>
    </span>
    <span>
      Stima stampa 3D
      <small>Calcolo costo + tempo basato su file G-code / modello</small>
    </span>
  </h1>
  <div class="subtitle">
    Carica un <strong>G-code</strong> (o inserisci i dati manualmente) e scegli il <strong>filamento</strong> dalla palette letta da Spoolman.  
    Il viewer prova a mostrare il modello con il colore scelto, così puoi controllare a colpo d’occhio se torna tutto.
  </div>

  <div class="layout" aria-label="Strumenti di stima stampa e anteprima modello">
    <div class="card" aria-labelledby="inputCardTitle">
      <div class="card-header">
        <div>
          <h2 id="inputCardTitle">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 4h7l4 4v12H5z" stroke="#ecfdf5" stroke-width="1.4" stroke-linejoin="round"/>
                <path d="M12 4v4h4" stroke="#bbf7d0" stroke-width="1.4" stroke-linecap="round"/>
              </svg>
            </span>
            Dati di input
          </h2>
          <div class="badge" aria-label="Sorgente dati G-code / manuale">
            <span class="dot-small" aria-hidden="true"></span>
            G-code • Bambu / Prusa / altri
          </div>
        </div>
        <div class="hint">
          File G-code consigliato: la stima è più precisa.<br>
          In alternativa puoi compilare i dati a mano.
        </div>
      </div>

      <div class="card-body">
        <div class="field-row">
          <label for="gcodeFile">
            File G-code
            <input type="file" id="gcodeFile" accept=".gcode,.gco,.g,.bgcode">
            <div class="help">
              Usa il G-code esportato dallo slicer (Bambu Studio, PrusaSlicer, Cura, ecc.).
            </div>
          </label>
        </div>

        <div class="field-row">
          <label for="machineSelect">
            Macchina / profilo di stampa
            <select id="machineSelect">
              <option value="generic">Generica / altro</option>
              <optgroup label="Bambu Lab">
                <option value="x1c">X1 Carbon</option>
                <option value="p1p">P1P</option>
                <option value="a1">A1 / A1 mini</option>
              </optgroup>
              <optgroup label="Prusa">
                <option value="mk4">Prusa MK4</option>
                <option value="mini">Prusa Mini</option>
              </optgroup>
            </select>
            <div class="help">
              Serve a dare una stima più coerente con la macchina reale.
            </div>
          </label>

          <label for="hourlyRate">
            Costo orario macchina (€ / ora)
            <input type="number" id="hourlyRate" step="0.1" min="0" value="1">
            <div class="help">
              Valore base dal backend: puoi modificarlo al volo.
            </div>
          </label>
        </div>

        <div class="presets-row">
          <label for="presetSelect">
            Preset di qualità (layer / velocità)
            <select id="presetSelect">
              <option value="">– Seleziona preset –</option>
              <optgroup label="Bambu X1C">
                <option value="x1c_standard_020">0.20 Standard</option>
                <option value="x1c_fine_016">0.16 Fine</option>
                <option value="x1c_fine_012">0.12 Fine+</option>
                <option value="x1c_lightning_020">0.20 Lightning</option>
                <option value="x1c_ultrafine_008">0.08 Ultra Fine</option>
              </optgroup>
            </select>
          </label>
          <div class="info-line">
            <span>Preset → <span id="presetInfo">nessuno selezionato</span></span>
            <span class="right">Puoi sempre modificare i parametri manualmente.</span>
          </div>
        </div>

        <div class="field-row actions">
          <div>
            <button id="btnEstimate" type="button">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 12h4l2-4 4 8 2-4h2" stroke="#ecfdf5" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Stima
            </button>
          </div>
          <button id="btnWizard" type="button" class="secondary">
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="8" stroke="#94a3b8" stroke-width="1.4"/>
              <path d="M12 9v6" stroke="#94a3b8" stroke-width="1.4" stroke-linecap="round"/>
              <circle cx="12" cy="7" r="0.8" fill="#94a3b8"/>
            </svg>
            Guida rapida
          </button>
        </div>

        <div id="out" class="out" aria-live="polite" aria-label="Risultato stima">
          In attesa di dati… Carica un G-code e premi “Stima”.
        </div>
      </div>
    </div>

    <div class="card" aria-labelledby="paletteCardTitle">
      <div class="card-header">
        <div>
          <h2 id="paletteCardTitle">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="7" stroke="#ecfdf5" stroke-width="1.4"/>
                <circle cx="9" cy="10" r="1" fill="#bfdbfe"/>
                <circle cx="14" cy="9" r="1" fill="#bbf7d0"/>
                <circle cx="15" cy="13" r="1" fill="#fed7aa"/>
                <circle cx="10" cy="14" r="1" fill="#f9a8d4"/>
              </svg>
            </span>
            Palette filamenti
          </h2>
          <div class="badge" aria-label="Sorgente dati da Spoolman">
            <span class="dot-small" aria-hidden="true"></span>
            Lettura da Spoolman
          </div>
        </div>
        <div class="hint">
          Ogni voce arriva direttamente da Spoolman.<br>
          I nomi colore possono essere sovrascritti da <code>colors.json</code>.
        </div>
      </div>

      <div class="card-body">
        <div id="palette" role="listbox" aria-label="Lista filamenti disponibili"></div>

        <div class="viewer-wrapper" aria-label="Anteprima modello 3D">
          <div id="viewerContainer">
            <div class="no-viewer" id="noViewerMsg">
              Carica un G-code o un modello supportato per vedere l’anteprima qui.<br>
              Il colore seguirà quello del filamento selezionato.
            </div>
          </div>
          <div class="viewer-overlay" aria-hidden="true"></div>
        </div>

        <div class="footer">
          <span class="tag">BETA</span>
          <span>Rendering 3D sperimentale · Se vedi problemi strani, il modello è probabilmente innocente.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wizard-overlay" id="wizard" aria-modal="true" role="dialog" aria-labelledby="wizardTitle">
    <div class="wizard">
      <button class="wizard-close" id="wizardClose" type="button">Chiudi</button>
      <h3 id="wizardTitle">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 3l2.2 4.5 5 .7-3.6 3.6.9 5-4.5-2.3-4.5 2.3.9-5L4.8 8.2l5-.7z" stroke="#ecfdf5" stroke-width="1.4" stroke-linejoin="round"/>
          </svg>
        </span>
        Guida rapida alla stima
      </h3>
      <p>
        Questo tool prova ad avvicinare il costo reale della stampa usando: G-code, dati macchina, costo orario e informazioni da Spoolman.
      </p>
      <ol>
        <li>Carica un <strong>file G-code</strong> generato dallo slicer.</li>
        <li>Controlla che la <strong>macchina</strong> selezionata sia quella giusta.</li>
        <li>Scegli un <strong>preset di qualità</strong> (o lascia “Generica” e sistemi a mano).</li>
        <li>Seleziona dalla <strong>palette</strong> il filamento che userai davvero.</li>
        <li>Premi <strong>“Stima”</strong>: il sistema calcola materiale, tempo e costo.</li>
      </ol>
      <p>
        Se un colore non ti piace, puoi rinominarlo/modificarlo in <code>colors.json</code>: ha precedenza su ogni altra fonte.
      </p>
      <div class="wizard-footer">
        <span>Qualsiasi bug grafico è colpa del gatto, non del G-code.</span>
        <span class="badge">
          <span class="dot-small" aria-hidden="true"></span>
          Palette + Viewer
        </span>
      </div>
    </div>
  </div>

  <script src="/js/libs/three.min.js"></script>
  <script src="/js/libs/STLLoader.js"></script>
  <script src="/js/libs/OrbitControls.js"></script>
  <script>
    // ---------- util base ----------
    function $(id){ return document.getElementById(id); }

    function formatEuro(v){
      if(isNaN(v)) return 'n/d';
      return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(v);
    }
    function formatTimeMinutes(m){
      if(!isFinite(m) || m<=0) return 'n/d';
      const h = Math.floor(m/60);
      const mm = Math.round(m%60);
      if(h<=0) return `${mm} min`;
      if(mm===0) return `${h} h`;
      return `${h} h ${mm} min`;
    }
    function hexNorm(h){
      if(!h) return '#777777';
      let s=String(h).trim();
      if(!s.startsWith('#')) s='#'+s;
      return s.toUpperCase();
    }
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||"");
      return m ? {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)} : {r:119,g:119,b:119};
    }
    function rgbToHsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      const d = max-min;
      let h=0;
      if(d!==0){
        switch(max){
          case r: h = ((g-b)/d + (g<b?6:0)); break;
          case g: h = ((b-r)/d + 2); break;
          case b: h = ((r-g)/d + 4); break;
        }
        h*=60;
      }
      const s = max===0?0:d/max;
      const v = max;
      return {h,s,v};
    }
    // ---------- mappa colori personalizzata (colors.json) ----------
    let COLORS_OVERRIDES = {};

    async function loadColorsOverrides(){
      try{
        const res = await fetch('/colors.json?nocache='+Date.now());
        if(!res.ok) return;
        const data = await res.json();
        if (data && typeof data === 'object') {
          COLORS_OVERRIDES = {};
          for (const [hex, name] of Object.entries(data)) {
            if(!hex) continue;
            const key = hexNorm(hex);
            COLORS_OVERRIDES[key] = String(name);
          }
        }
      }catch(err){
        console.warn('Impossibile caricare colors.json', err);
      }
    }

    function nameFromHex(hex, isTransparent){
      hex = hexNorm(hex);
      if(isTransparent) return 'Trasparente';
      const {r,g,b}=hexToRgb(hex);
      const {h,s,v}=rgbToHsv(r,g,b); // h in [0,360), s,v in [0,1]

      // grigi / bianchi / neri
      if(s < 0.10){
        if(v > 0.90) return 'Bianco';
        if(v < 0.15) return 'Nero';
        return 'Grigio';
      }

      // marrone (arancio scuro)
      if(h>=15 && h<40 && v<0.60) return 'Marrone';

      // oro dedicato
      if(h>=40 && h<55 && s>0.40 && v>0.60) return 'Oro';

      // fasce principali
      if(h<15 || h>=345) return 'Rosso';
      if(h>=15 && h<40)  return 'Arancione';
      if(h>=55 && h<75)  return 'Giallo';
      if(h>=75 && h<160) return 'Verde';
      if(h>=160 && h<190) return 'Ciano';
      if(h>=190 && h<255) return 'Blu';
      if(h>=255 && h<295) return 'Viola';
      if(h>=295 && h<345) return 'Rosa';
      return 'N/D';
    }

    function coherentName(hex, given, isTransparent){
      const auto = nameFromHex(hex, isTransparent);
      if(!given) return auto;
      const g = String(given).trim().toLowerCase();
      const a = String(auto).toLowerCase();
      // se sono equivalenti o sinonimi, tiene quello di Spoolman
      const syn = {
        'fucsia':'fucsia','magenta':'magenta','azzurro':'blu chiaro',
        'cyan':'ciano','ciano':'ciano','brown':'marrone','maroon':'marrone',
        'grey':'grigio','silver':'grigio','argento':'grigio',
        'gold':'oro','golden':'oro','dorato':'oro','giallo oro':'oro',
        'transparent':'trasparente','translucent':'trasparente'
      };
      const g2 = syn[g] || g;
      if(g2===a) return given;

      // se differenza macroscopica (es. g=bianco ma hex non è vicino al bianco) → usa auto
      const hx = hexNorm(hex);
      if(g.includes('bianco') && hx!=='#FFFFFF') return auto;
      if(g.includes('trasp')) return 'Trasparente';
      // preferisci auto se dato è in un altro cluster (es. blu vs viola, arancione vs oro)
      return auto;
    }

    // ---------- stato ----------
    let selectedKey = null;
    let currentViewerUrl = null;
    let selectedMachine = "generic";
    let inventoryItems = [];
    const REFRESH_MS = 60000; // 60 s

    // ---------- palette ----------
    async function loadPalette(){
      const res = await fetch('/inventory?nocache='+Date.now());
      const data = await res.json();
      const raw = Array.isArray(data.items) ? data.items : [];

      inventoryItems = raw.map((it,i)=>{
        // campi robusti dal backend
        const hex = hexNorm(it.color_hex || it.hex || '#777777');
        const is_transparent = Boolean(it.is_transparent) || /(transpar|traspar)/i.test(String(it.color_name||''));

        // 1) se presente in colors.json, usa SEMPRE il nome definito lì
        const overrideName = COLORS_OVERRIDES[hex];

        // 2) altrimenti prova a conciliare nome spoolman + analisi HSV
        const autoOrCoherent = coherentName(hex, it.color_name, is_transparent);

        const color_name = overrideName || autoOrCoherent;
        const key = it.key || `${(it.material||'mat')}_${hex}_${i}`;
        return { ...it, color: hex, key, is_transparent, color_name };
      });

      renderPalette(inventoryItems);
    }

    function renderPalette(items){
      const box = document.getElementById('palette');
      box.innerHTML = '';
      items
        .sort((a,b)=> (a.material||'').localeCompare(b.material||'') || (a.color_name||'').localeCompare(b.color_name||'') )
        .forEach(it=>{
          const hex = hexNorm(it.color);
          const price = (it.price_per_kg!=null) ? `${Number(it.price_per_kg).toFixed(2)} ${it.currency||'EUR'}/kg` : 'n/d';
          const colorName = it.color_name || nameFromHex(hex, it.is_transparent);

          const row = document.createElement('div');
          row.className='pill';
          row.setAttribute('role','option');
          row.setAttribute('aria-label', `${it.material}, ${colorName}, ${price}`);
          row.setAttribute('aria-selected', selectedKey===it.key ? 'true' : 'false');

          const left = document.createElement('div'); left.className='left';
          const dot = document.createElement('span'); dot.className='dot' + (it.is_transparent ? ' transparent' : '');
          if(!it.is_transparent){ dot.style.backgroundColor = hex; }
          dot.title = colorName; dot.setAttribute('aria-hidden','true');

          const col = document.createElement('div');
          const t1 = document.createElement('div'); t1.className='title'; t1.textContent = it.material || 'n/d';
          const t2 = document.createElement('div'); t2.className='sub'; t2.textContent = colorName;
          col.appendChild(t1); col.appendChild(t2);

          left.appendChild(dot); left.appendChild(col);
          const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = price;

          row.appendChild(left);
          row.appendChild(priceEl);

          row.onclick = ()=>{
            selectedKey = it.key;
            renderPalette(items);
            applySelectedFilament(it);
          };

          if(selectedKey===it.key){
            row.classList.add('selected');
          }

          box.appendChild(row);
        });
    }

    function applySelectedFilament(it){
      // Qui puoi integrare con il viewer 3D
      // Per ora aggiorna solo il testo nel risultato
      const out = document.getElementById('out');
      const colorName = it.color_name || nameFromHex(it.color, it.is_transparent);
      const base = out.textContent || '';
      const extra = `\nFilamento selezionato: ${it.material||'n/d'} – ${colorName} (${it.color}).`;
      out.textContent = base.replace(/\nFilamento selezionato:.*$/,'') + extra;
      // TODO: passare il colore al viewer 3D
      updateViewerColor(it.color, it.is_transparent);
    }

    // ---------- viewer 3D ----------
    let viewerScene = null;
    let viewerRenderer = null;
    let viewerCamera = null;
    let viewerMesh = null;
    let viewerColor = 0x999999;

    function initViewer(){
      const container = document.getElementById('viewerContainer');
      if(!container) return;
      const canvas = document.createElement('canvas');
      container.innerHTML = '';
      container.appendChild(canvas);

      viewerRenderer = new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
      viewerRenderer.setPixelRatio(window.devicePixelRatio||1);
      viewerRenderer.setSize(container.clientWidth,260);

      viewerScene = new THREE.Scene();
      viewerScene.background = null;

      const aspect = container.clientWidth/260;
      viewerCamera = new THREE.PerspectiveCamera(35,aspect,0.1,100);
      viewerCamera.position.set(0,0,60);

      const light1 = new THREE.DirectionalLight(0xffffff,0.8);
      light1.position.set(1,1,1);
      viewerScene.add(light1);
      const light2 = new THREE.DirectionalLight(0xffffff,0.4);
      light2.position.set(-1,0.5,-1);
      viewerScene.add(light2);
      const amb = new THREE.AmbientLight(0xffffff,0.6);
      viewerScene.add(amb);

      const controls = new THREE.OrbitControls(viewerCamera, viewerRenderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.6;
      controls.zoomSpeed = 0.7;
      controls.panSpeed = 0.4;

      function animate(){
        requestAnimationFrame(animate);
        controls.update();
        viewerRenderer.render(viewerScene, viewerCamera);
      }
      animate();
    }

    function setViewerModelFromSTL(url){
      if(!viewerScene){
        initViewer();
      }
      if(!viewerScene) return;
      const loader = new THREE.STLLoader();
      loader.load(url, geometry=>{
        if(viewerMesh){
          viewerScene.remove(viewerMesh);
        }
        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        const size = new THREE.Vector3();
        bbox.getSize(size);
        const center = new THREE.Vector3();
        bbox.getCenter(center);
        geometry.translate(-center.x,-center.y,-center.z);

        const material = new THREE.MeshStandardMaterial({
          color: viewerColor,
          metalness:0.1,
          roughness:0.4
        });
        viewerMesh = new THREE.Mesh(geometry, material);
        viewerScene.add(viewerMesh);

        const maxDim = Math.max(size.x,size.y,size.z);
        const dist = maxDim*1.8;
        viewerCamera.position.set(dist,dist,dist);
        viewerCamera.lookAt(0,0,0);
      });
    }

    function updateViewerColor(hex, isTransparent){
      if(!hex) return;
      const h = hexNorm(hex).replace('#','');
      const num = parseInt(h,16);
      if(!isFinite(num)) return;
      viewerColor = num;
      if(viewerMesh && viewerMesh.material){
        viewerMesh.material.color.setHex(num);
        viewerMesh.material.opacity = isTransparent ? 0.6 : 1.0;
        viewerMesh.material.transparent = isTransparent;
        viewerMesh.material.needsUpdate = true;
      }
    }

    // ---------- stima ----------
    async function estimate(){
      const fileInput = document.getElementById('gcodeFile');
      const rateInput = document.getElementById('hourlyRate');
      const out = document.getElementById('out');
      const machineSel = document.getElementById('machineSelect');

      const hourlyRate = parseFloat(rateInput.value||'0') || 0;
      const machine = machineSel.value || 'generic';

      if(!fileInput.files || !fileInput.files[0]){
        out.textContent = 'Carica un file G-code per calcolare la stima.';
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('hourly_rate', String(hourlyRate||0));
      formData.append('machine', machine);

      out.textContent = 'Analisi G-code in corso…';

      try{
        const res = await fetch('/estimate', { method:'POST', body:formData });
        if(!res.ok){
          const txt = await res.text();
          out.textContent = `Errore dal server (${res.status}): ${txt}`;
          return;
        }
        const data = await res.json();
        const timeMin = Number(data.estimated_time_min||0);
        const matG = Number(data.filament_used_g||0);
        const costMat = Number(data.material_cost||0);
        const costTime = Number(data.time_cost||0);
        const total = Number(data.total_cost||0);

        let txt = '';
        txt += `File: ${file.name}\n`;
        txt += `Tempo stimato: ${formatTimeMinutes(timeMin)}\n`;
        txt += `Materiale: ${matG.toFixed(1)} g\n`;
        txt += `Costo materiale: ${formatEuro(costMat)}\n`;
        txt += `Costo macchina: ${formatEuro(costTime)}\n`;
        txt += `------------------------------\n`;
        txt += `Totale: ${formatEuro(total)}\n`;

        if(selectedKey){
          const it = inventoryItems.find(x=>x.key===selectedKey);
          if(it){
            const cn = it.color_name || nameFromHex(it.color, it.is_transparent);
            txt += `\nFilamento selezionato: ${it.material||'n/d'} – ${cn} (${it.color}).`;
          }
        }

        out.textContent = txt;
      }catch(err){
        console.error(err);
        out.textContent = 'Errore durante la stima. Controlla che il backend sia raggiungibile.';
      }
    }

    // ---------- preset macchina ----------
    const PRESETS = {
      x1c_standard_020: { layer_height:0.2, speed_factor:1.0, note:'X1C 0.20 Standard' },
      x1c_fine_016:     { layer_height:0.16, speed_factor:0.9, note:'X1C 0.16 Fine' },
      x1c_fine_012:     { layer_height:0.12, speed_factor:0.8, note:'X1C 0.12 Fine+' },
      x1c_lightning_020:{ layer_height:0.2, speed_factor:1.2, note:'X1C 0.20 Lightning' },
      x1c_ultrafine_008:{ layer_height:0.08, speed_factor:0.7, note:'X1C 0.08 Ultra Fine' }
    };

    function applyPreset(key){
      const info = document.getElementById('presetInfo');
      if(!key || !PRESETS[key]){
        info.textContent = 'nessuno selezionato';
        return;
      }
      const p = PRESETS[key];
      info.textContent = `${p.note} • Layer ~${p.layer_height} mm • Velocità x${p.speed_factor}`;
    }

    // ---------- init ----------
    window.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('btnEstimate');
      if(btn){
        btn.addEventListener('click', estimate);
      }

      const presetSel = document.getElementById('presetSelect');
      if(presetSel){
        presetSel.onchange = () => applyPreset(presetSel.value);
        if (!selectedMachine || selectedMachine === 'generic') {
          presetSel.value = 'x1c_standard_020';
          applyPreset('x1c_standard_020');
        }
      }

      (async () => {
        try{
          await loadColorsOverrides();
        }catch(e){
          console.warn('colors.json non caricato, continuo con auto-detect', e);
        }
        await loadPalette();
        setInterval(loadPalette, REFRESH_MS);
      })();

      const wizardBtn = document.getElementById('btnWizard');
      const wizardOverlay = document.getElementById('wizard');
      const wizardClose = document.getElementById('wizardClose');
      if(wizardBtn && wizardOverlay){ wizardBtn.onclick = () => { wizardOverlay.style.display = 'flex'; }; }
      if(wizardClose){ wizardClose.onclick = () => { wizardOverlay.style.display = 'none'; }; }

      // init viewer (vuoto, si popola al bisogno)
      initViewer();
    });
  </script>
</body>
</html>
