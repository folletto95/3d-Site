<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://w...viewBox='0 0 16 16'><text y='14' font-size='14'>ðŸ§µ</text></svg>">
  <style>
  :root{
    --bg:#020617;
    --bg-soft:#0b1120;
    --card:#020617;
    --card-soft:#020617;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --ring:#1f2937;
    --accent:#22c55e;
    --accent-soft:rgba(34,197,94,0.14);
    --danger:#f97373;
  }

  *{
    box-sizing:border-box;
  }

  body{
    margin:0;
    min-height:100vh;
    background:
      radial-gradient(circle at top,rgba(34,197,94,0.18),transparent 60%),
      radial-gradient(circle at bottom,rgba(59,130,246,0.22),transparent 55%),
      #020617;
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif;
    display:flex;
    flex-direction:column;
  }

  .wrap{
    max-width:1180px;
    margin:24px auto 32px;
    padding:0 18px 24px;
  }

  h1{
    margin:0 0 6px;
    font-size:clamp(24px,4vw,30px);
    letter-spacing:0.02em;
    display:flex;
    align-items:center;
    gap:10px;
  }

  h1::before{
    content:"";
    width:32px;
    height:32px;
    border-radius:12px;
    background:
      radial-gradient(circle at 30% 20%,#22c55e,#16a34a 40%,#022c22 100%);
    box-shadow:0 0 0 1px rgba(15,23,42,0.8),0 18px 40px rgba(15,23,42,0.9);
    display:inline-block;
  }

  h2{
    margin:0 0 12px;
    font-size:17px;
    letter-spacing:0.03em;
    text-transform:uppercase;
    color:#cbd5f5;
  }

  .hint{
    color:var(--muted);
    font-size:12px;
  }

  .hint b{
    color:#e5e7eb;
    font-weight:600;
  }

  .grid{
    display:grid;
    grid-template-columns:1.25fr 1.1fr;
    gap:18px;
    margin-top:18px;
  }

  @media (max-width:1000px){
    .grid{
      grid-template-columns:1fr;
    }
  }

  .card{
    position:relative;
    background:
      radial-gradient(circle at top left,rgba(148,163,184,0.18),transparent 55%),
      radial-gradient(circle at bottom right,rgba(15,23,42,0.9),#020617 60%);
    border-radius:18px;
    padding:16px 16px 18px;
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
    overflow:hidden;
  }

  .card::before{
    content:"";
    position:absolute;
    inset:-120px;
    background:radial-gradient(circle at top,rgba(34,197,94,0.16),transparent 60%);
    opacity:0.7;
    pointer-events:none;
  }

  .card > *{
    position:relative;
    z-index:1;
  }

  /* Palette filamenti */

  .palette{
    display:flex;
    flex-direction:column;
    gap:6px;
    max-height:360px;
    overflow:auto;
    padding-right:4px;
    margin-top:4px;
  }

  .pill{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(51,65,85,0.9);
    background:rgba(15,23,42,0.94);
    cursor:pointer;
    font-size:13px;
    transition:
      border-color .12s ease,
      background .12s ease,
      transform .08s ease,
      box-shadow .12s ease;
  }

  .pill:hover{
    background:rgba(15,23,42,0.99);
    border-color:rgba(148,163,184,0.85);
    transform:translateY(-1px);
    box-shadow:0 8px 22px rgba(15,23,42,0.9);
  }

  .pill[aria-selected="true"]{
    border-color:var(--accent);
    box-shadow:
      0 0 0 1px rgba(34,197,94,0.5),
      0 14px 34px rgba(34,197,94,0.4);
    background:linear-gradient(135deg,rgba(34,197,94,0.22),rgba(15,23,42,0.98));
  }

  .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .dot{
    width:18px;
    height:18px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.9);
    box-shadow:
      0 0 0 1px rgba(15,23,42,0.6),
      0 0 0 2px rgba(15,23,42,0.4),
      0 0 8px rgba(15,23,42,0.9);
    background:#6b7280;
    position:relative;
    overflow:hidden;
    flex-shrink:0;
  }

  .dot.transparent{
    background:repeating-conic-gradient(#475569 0 25%,#1e293b 0 50%) 50%/12px 12px;
  }

  .dot.transparent::after{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(135deg,rgba(15,23,42,0.85),transparent);
  }

  .title{
    font-weight:600;
    font-size:13px;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }

  .sub{
    font-size:11px;
    color:var(--muted);
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }

  .price{
    font-weight:600;
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    flex-shrink:0;
  }

  /* Parametri / form */

  .row{
    display:flex;
    gap:10px;
    align-items:flex-end;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .row label{
    flex:1 1 150px;
  }

  input[type="file"],
  input[type="text"],
  select,
  button{
    border-radius:999px;
    border:1px solid rgba(51,65,85,0.9);
    background:#020617;
    color:var(--text);
    padding:8px 11px;
    font-size:13px;
    outline:none;
    transition:
      border-color .15s ease,
      box-shadow .15s ease,
      background .15s ease,
      transform .08s ease;
  }

  input[type="file"]{
    padding:8px;
    border-radius:10px;
    background:#020617;
  }

  input::placeholder{
    color:rgba(148,163,184,0.8);
  }

  input:focus,
  select:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(34,197,94,0.4);
    background:#020617;
  }

  button{
    cursor:pointer;
    background:linear-gradient(135deg,#22c55e,#16a34a);
    color:#ecfdf5;
    font-weight:500;
    border:none;
    box-shadow:0 14px 30px rgba(22,163,74,0.45);
  }

  button:hover{
    transform:translateY(-1px);
    box-shadow:0 18px 42px rgba(22,163,74,0.55);
    filter:brightness(1.03);
  }

  button:active{
    transform:translateY(0);
    box-shadow:0 10px 24px rgba(22,163,74,0.5);
    filter:brightness(0.98);
  }

  /* Viewer 3D */

  .viewer{
    height:320px;
    border-radius:16px;
    border:1px dashed rgba(148,163,184,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    font-size:13px;
    background:radial-gradient(circle at top,rgba(15,23,42,0.9),#020617 70%);
    margin-bottom:8px;
    padding:8px;
    text-align:center;
  }

  .viewer.drag{
    border-color:var(--accent);
    color:var(--accent);
    box-shadow:0 0 0 1px rgba(34,197,94,0.5);
  }

  /* Box output */

  .out{
    margin-top:16px;
    font-size:15px;
    line-height:1.5;
    background:#020617;
    padding:12px 14px;
    border-radius:14px;
    color:var(--text);
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:0 12px 28px rgba(15,23,42,0.85);
    white-space:pre-wrap;
  }

  .out b{
    color:var(--accent);
    font-size:18px;
  }

  /* Estimation grid */
  .est{
    display:grid;
    grid-template-columns:repeat(6,minmax(120px,1fr));
    gap:10px;
    margin-top:10px;
  }

  @media (max-width:1100px){
    .est{
      grid-template-columns:repeat(3,1fr);
    }
  }

  /* Campi avanzati nascosti */
  .advanced{
    display:none;
  }

  /* Wizard */

  #btnWizard{
    position:fixed;
    top:18px;
    right:18px;
    padding:7px 12px;
    font-size:13px;
    z-index:1000;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.92);
    color:var(--text);
    box-shadow:0 10px 24px rgba(15,23,42,0.9);
  }

  #btnWizard:hover{
    border-color:var(--accent);
    color:#bbf7d0;
  }

  .wizard-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.88);
    z-index:999;
    display:none;
    align-items:center;
    justify-content:center;
  }

  .wizard-box{
    max-width:600px;
    width:100%;
    margin:0 16px;
    background:#020617;
    border-radius:18px;
    padding:20px 18px 16px;
    border:1px solid rgba(148,163,184,0.7);
    box-shadow:0 24px 60px rgba(0,0,0,0.9);
  }

  .wizard-box h2{
    margin-top:0;
    margin-bottom:8px;
    font-size:18px;
  }

  .wizard-box p,
  .wizard-box li{
    font-size:13px;
    color:var(--muted);
  }

  .wizard-box button{
    background:transparent;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    color:var(--text);
    padding:6px 10px;
    box-shadow:none;
  }

  .wizard-box button:hover{
    border-color:var(--accent);
    color:#bbf7d0;
    box-shadow:0 10px 24px rgba(15,23,42,0.9);
  }

  
  </style>

  <!-- Import map per Three r160+ (DEVE stare nel <head> prima dei moduli) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- Collante JSM â†’ window.THREE -->
  <script type="module">
    import * as THREE_NS from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';

    window.THREE = THREE_NS;
    window.THREE.OrbitControls = OrbitControls;
    window.THREE.STLLoader = STLLoader;
  </script>

  <!-- Modulo principale -->
  <script type="module">
    // Se esiste un THREE legacy (da CDN <script src="...three.min.js">), prova a usarlo
    const THREE = window.THREE || await import('three');
    const OrbitControls = THREE.OrbitControls || (await import('three/addons/controls/OrbitControls.js')).OrbitControls;
    const STLLoader = THREE.STLLoader || (await import('three/addons/loaders/STLLoader.js')).STLLoader;

    /** @type {THREE.Renderer | null} */
    let renderer = null;
    /** @type {THREE.Scene | null} */
    let scene = null;
    /** @type {THREE.PerspectiveCamera | null} */
    let camera = null;
    /** @type {THREE.OrbitControls | null} */
    let controls = null;
    /** @type {THREE.Mesh | null} */
    let mesh = null;

    const viewerEl = document.getElementById('viewer');

    function initViewer() {
      if (!viewerEl || viewerEl.dataset.initialized === '1') return;
      viewerEl.dataset.initialized = '1';

      const width = viewerEl.clientWidth || 600;
      const height = viewerEl.clientHeight || 400;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(width, height);
      renderer.setClearColor(0x020617, 1);
      viewerEl.innerHTML = '';
      viewerEl.appendChild(renderer.domElement);

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(35, width / height, 0.1, 1000);
      camera.position.set(0, 0, 80);

      const light1 = new THREE.DirectionalLight(0xffffff, 1.0);
      light1.position.set(2, 4, 5);
      scene.add(light1);

      const light2 = new THREE.DirectionalLight(0xffffff, 0.6);
      light2.position.set(-3, -1, -2);
      scene.add(light2);

      const amb = new THREE.AmbientLight(0xffffff, 0.4);
      scene.add(amb);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.rotateSpeed = 0.7;
      controls.zoomSpeed = 0.7;
      controls.panSpeed = 0.5;

      function onResize() {
        if (!renderer || !camera) return;
        const w = viewerEl.clientWidth || 600;
        const h = viewerEl.clientHeight || 400;
        renderer.setSize(w, h);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', onResize);

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      viewerEl.textContent = '';
    }

    function loadSTL(url) {
      initViewer();
      if (!scene || !camera) return;

      // Carica STL
      const loader = new STLLoader();
      loader.load(url, geometry => {
        if (mesh) {
          scene.remove(mesh);
        }

        // Centro geometria
        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        const center = bbox.getCenter(new THREE.Vector3());
        geometry.translate(-center.x, -center.y, -center.z);

        // Calcola dimensione per adattare la camera
        const size = bbox.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);

        const material = new THREE.MeshStandardMaterial({
          color: 0x22c55e,
          metalness: 0.15,
          roughness: 0.4
        });

        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        const dist = maxDim * 1.8 || 80;
        camera.position.set(dist, dist * 0.5, dist);
        camera.lookAt(0, 0, 0);
      }, undefined, err => {
        console.error('Errore caricamento STL:', err);
      });
    }

    // Expose in window per riuso
    window.STL_VIEWER = { initViewer, loadSTL };
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Dati e prezzi da Spoolman (â‚¬/kg). Costo macchina fisso lato server. La stima usa CuraEngine.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <input id="paletteFilter" type="text" placeholder="Filtra per nome / materiale / colore..." style="margin-bottom:8px; width:100%" oninput="filterPalette()" />
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce: <b>Materiale</b> â€” <span class="title">Nome colore</span> â€” <b>â‚¬/kg</b>. Aggiornamento ogni 60 s.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">Trascina qui un file o caricalo dal pulsante sotto.</div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>File & Stima</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip,.step,.stp" multiple />
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="
          flex:1 1 220px;
        " />
        <button id="btnFetch">Carica da URL / Thingiverse</button>
      </div>

      <div class="row" style="margin-top:12px">
        <label>Volume ugello (mmÂ³/s) 
          <input id="nozzleVol" type="text" value="12" />
        </label>
        <label>VelocitÃ  media (mm/s)
          <input id="speed" type="text" value="80" />
        </label>
        <label>Layer height (mm)
          <select id="layerHeight">
            <option value="0.20">0.20 mm</option>
            <option value="0.16">0.16 mm</option>
            <option value="0.12">0.12 mm</option>
            <option value="0.28">0.28 mm</option>
          </select>
        </label>
        <label class="advanced">Infill
          <select id="infill">
            <option value="15">15%</option>
            <option value="5">5%</option>
            <option value="20">20%</option>
            <option value="40">40%</option>
          </select>
        </label>
        
        <label class="advanced">Supporti
          <select id="supports">
            <option value="0">No</option>
            <option value="1">SÃ¬</option>
          </select>
        </label>
        <label class="advanced">Numero di perimetri
          <select id="perimeters">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>

      </div>

      <div class="row" style="margin-top:12px">
        <label>Seleziona filamento
          <select id="filamentSelect">
            <option value="">(usa selezione da palette)</option>
          </select>
        </label>
        <label>Prezzo filamento (â‚¬/kg)
          <input id="priceKg" type="text" value="20" />
        </label>
        <label>Costo macchina (â‚¬/h)
          <input id="machineCost" type="text" value="1.00" />
        </label>
      </div>

      <div class="row" style="margin-top:12px">
        <label>Filamento usato (g)
          <input id="filamentUsed" type="text" placeholder="calcolato da G-code, se presente" />
        </label>
        <label>Tempo di stampa (minuti)
          <input id="printTime" type="text" placeholder="calcolato da G-code, se presente" />
        </label>
        <div style="display:flex;align-items:end">
          <button id="btnEstimate">Stima</button>
        </div>
      </div>

      <div id="out" class="out"></div>
    </div>
  </div>

  <button id="btnWizard" title="Apri guida" style="position:fixed;top:16px;right:16px;background:#0b1527;border:1px solid var(--ring);padding:8px 12px;border-radius:12px;font-size:14px;z-index:1000;cursor:pointer">Guida</button>

  <div id="wizard" class="wizard-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;">
    <div class="wizard-box" style="max-width:600px;margin:10% auto;background:var(--card);padding:24px;border-radius:16px;box-shadow:0 0 12px rgba(0,0,0,0.5);">
      <h2 style="margin-top:0">Benvenuto!</h2>
      <p>Questa guida ti accompagna ai passi principali:</p>
      <ol>
        <li>Controlla che la palette mostri i filamenti corretti da Spoolman.</li>
        <li>Seleziona un filamento dalla palette (o dal menu a tendina).</li>
        <li>Carica il modello 3D nel viewer (STL/3MF/OBJ).</li>
        <li>Imposta (se vuoi) i parametri di velocitÃ , layer, ecc.</li>
        <li>Premi "Stima" per calcolare il costo di stampa.</li>
      </ol>
      <p>Puoi chiudere questa finestra cliccando il bottone qui sotto.</p>
      <button id="wizardClose">Chiudi guida</button>
    </div>
  </div>

  <script>
    const API_BASE = '';
    const spoolEndpointCandidates = [
      '/api/spools',
      '/api/v1/spool/?page_size=1000',
      '/api/v1/spools?page_size=1000',
      '/api/spool/?page_size=1000'
    ];

    let inventory = [];
    let selectedSpool = null;

    async function detectSpoolEndpoint() {
      for (const path of spoolEndpointCandidates) {
        try {
          const res = await fetch(path);
          if (res.ok) {
            const ct = res.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
              console.log('Spool endpoint trovato:', path);
              return path;
            } else {
              console.warn('Endpoint', path, 'risponde ma non JSON:', ct);
            }
          }
        } catch (err) {
          console.warn('Errore provando endpoint', path, err);
        }
      }
      throw new Error("Nessun endpoint spoolman valido trovato");
    }

    function renderPalette() {
      const container = document.getElementById('palette');
      container.innerHTML = '';

      const filterValue = (document.getElementById('paletteFilter').value || '').toLowerCase();

      for (const item of inventory) {
        const {
          color_hex,
          material,
          remaining_g,
          name,
          price_per_kg,
          currency,
          is_transparent
        } = item;

        const colorHex = (color_hex || '#999999').toUpperCase();
        const mat = material || 'N/D';
        const colorName = name || 'N/D';
        const price = (price_per_kg != null) ? `${price_per_kg.toFixed(2)} ${currency || 'EUR'}` : 'N/D';

        const searchable = `${mat} ${colorName} ${price}`.toLowerCase();
        if (filterValue && !searchable.includes(filterValue)) {
          continue;
        }

        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.setAttribute('role', 'option');
        pill.setAttribute('aria-label', `${mat}, ${colorName}, ${price}`);
        if (selectedSpool === item) {
          pill.setAttribute('aria-selected', 'true');
        } else {
          pill.setAttribute('aria-selected', 'false');
        }

        const left = document.createElement('div');
        left.className = 'left';

        const dot = document.createElement('span');
        dot.className = 'dot';
        if (is_transparent) {
          dot.classList.add('transparent');
        } else {
          dot.style.backgroundColor = colorHex;
        }

        const textWrap = document.createElement('div');
        const titleEl = document.createElement('div');
        titleEl.className = 'title';
        titleEl.textContent = mat;

        const subEl = document.createElement('div');
        subEl.className = 'sub';
        subEl.textContent = `${colorName} â€“ ${remaining_g != null ? remaining_g + ' g' : '? g'}`;

        textWrap.appendChild(titleEl);
        textWrap.appendChild(subEl);

        left.appendChild(dot);
        left.appendChild(textWrap);

        const priceEl = document.createElement('div');
        priceEl.className = 'price';
        priceEl.textContent = price;

        pill.appendChild(left);
        pill.appendChild(priceEl);

        pill.addEventListener('click', () => {
          selectedSpool = item;
          const filamentSelect = document.getElementById('filamentSelect');
          if (filamentSelect) {
            filamentSelect.value = colorHex;
            document.getElementById('priceKg').value = price_per_kg != null ? price_per_kg.toString() : '20';
          }
          renderPalette();
        });

        container.appendChild(pill);
      }
    }

    async function loadInventory() {
      try {
        const endpoint = await detectSpoolEndpoint();
        const res = await fetch(endpoint);
        const data = await res.json();
        if (Array.isArray(data.results)) {
          inventory = data.results.map(spool => ({
            color_hex: spool.color_hex,
            material: spool.material,
            remaining_g: spool.remaining_weight ?? spool.remaining_g,
            name: spool.name,
            price_per_kg: spool.price_per_kg,
            currency: spool.currency || 'EUR',
            is_transparent: spool.is_transparent
          }));
        } else if (Array.isArray(data.items)) {
          inventory = data.items;
        } else if (Array.isArray(data)) {
          inventory = data;
        } else {
          console.warn('Formato risposta spoolman non riconosciuto', data);
          inventory = [];
        }

        const filamentSelect = document.getElementById('filamentSelect');
        filamentSelect.innerHTML = '<option value="">(usa selezione da palette)</option>';

        for (const item of inventory) {
          const colorHex = (item.color_hex || '#999999').toUpperCase();
          const opt = document.createElement('option');
          opt.value = colorHex;
          opt.textContent = `${item.material || 'N/D'} â€“ ${item.name || 'N/D'} (${colorHex})`;
          filamentSelect.appendChild(opt);
        }

        renderPalette();
      } catch (error) {
        console.error('Errore caricando inventario:', error);
      }
    }

    function filterPalette() {
      renderPalette();
    }

    async function uploadModel(file) {
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch(API_BASE + '/upload_model', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) {
          throw new Error('Errore upload: ' + res.statusText);
        }
        const data = await res.json();
        return data;
      } catch (error) {
        console.error(error);
        alert('Errore caricando il modello: ' + error.message);
        return null;
      }
    }

    async function fetchModelFromUrl(url) {
      try {
        const res = await fetch(API_BASE + '/fetch_model?url=' + encodeURIComponent(url));
        if (!res.ok) {
          throw new Error('Errore fetch: ' + res.statusText);
        }
        const data = await res.json();
        return data;
      } catch (error) {
        console.error(error);
        alert('Errore fetching modello da URL: ' + error.message);
        return null;
      }
    }

    async function analyzeGcode(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(API_BASE + '/analyze_gcode', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) {
          throw new Error('Errore analisi G-code: ' + res.statusText);
        }
        const data = await res.json();
        document.getElementById('filamentUsed').value = data.filament_used_g != null ? data.filament_used_g.toFixed(1) : '';
        document.getElementById('printTime').value = data.estimated_time_minutes != null ? data.estimated_time_minutes.toFixed(1) : '';
      } catch (error) {
        console.error(error);
        alert('Errore analizzando il G-code: ' + error.message);
      }
    }

    function estimate() {
      const filamentUsed = parseFloat(document.getElementById('filamentUsed').value.replace(',', '.')) || 0;
      const printTime = parseFloat(document.getElementById('printTime').value.replace(',', '.')) || 0;
      const priceKg = parseFloat(document.getElementById('priceKg').value.replace(',', '.')) || 0;
      const machineCost = parseFloat(document.getElementById('machineCost').value.replace(',', '.')) || 0;

      const filamentCost = (filamentUsed / 1000) * priceKg;
      const machineTimeHours = printTime / 60;
      const machineCostTotal = machineTimeHours * machineCost;
      const total = filamentCost + machineCostTotal;

      const out = document.getElementById('out');
      out.innerHTML = `
        <div class="est">
          <div>
            <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.06em">Filamento</div>
            <div><b>${filamentUsed.toFixed(1)} g</b></div>
          </div>
          <div>
            <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.06em">Tempo stimato</div>
            <div><b>${printTime.toFixed(1)} min</b></div>
          </div>
          <div>
            <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.06em">Costo materiale</div>
            <div><b>${filamentCost.toFixed(2)} â‚¬</b></div>
          </div>
          <div>
            <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.06em">Costo macchina</div>
            <div><b>${machineCostTotal.toFixed(2)} â‚¬</b></div>
          </div>
          <div>
            <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.06em">Totale</div>
            <div><b>${total.toFixed(2)} â‚¬</b></div>
          </div>
        </div>
      `;
    }

    function setupDragAndDrop() {
      const viewer = document.getElementById('viewer');
      viewer.addEventListener('dragover', (e) => {
        e.preventDefault();
        viewer.classList.add('drag');
        viewer.textContent = 'Rilascia il file qui...';
      });
      viewer.addEventListener('dragleave', (e) => {
        e.preventDefault();
        viewer.classList.remove('drag');
        viewer.textContent = 'Trascina qui un file o caricalo dal pulsante sotto.';
      });
      viewer.addEventListener('drop', async (e) => {
        e.preventDefault();
        viewer.classList.remove('drag');
        const file = e.dataTransfer.files[0];
        if (!file) return;
        const data = await uploadModel(file);
        if (data && data.stl_url) {
          viewer.textContent = 'Modello caricato, rendering in corso...';
          window.STL_VIEWER.loadSTL(data.stl_url);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.STL_VIEWER.initViewer();
      setupDragAndDrop();
      loadInventory();

      document.getElementById('file').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          const data = await uploadModel(files[0]);
          if (data && data.stl_url) {
            document.getElementById('viewer').textContent = 'Modello caricato, rendering in corso...';
            window.STL_VIEWER.loadSTL(data.stl_url);
          }
          if (files[0].name.toLowerCase().endsWith('.gcode')) {
            await analyzeGcode(files[0]);
          }
        }
      });

      document.getElementById('btnFetch').addEventListener('click', async () => {
        const url = document.getElementById('url').value.trim();
        if (!url) {
          alert('Inserisci una URL valida.');
          return;
        }
        const data = await fetchModelFromUrl(url);
        if (data && data.stl_url) {
          document.getElementById('viewer').textContent = 'Modello caricato, rendering in corso...';
          window.STL_VIEWER.loadSTL(data.stl_url);
        }
      });

      document.getElementById('btnEstimate').addEventListener('click', estimate);

      const btnWizard = document.getElementById('btnWizard');
      const wizard = document.getElementById('wizard');
      const wizardClose = document.getElementById('wizardClose');

      if (btnWizard && wizard) {
        btnWizard.addEventListener('click', () => {
          wizard.style.display = 'flex';
        });
      }

      if (wizardClose && wizard) {
        wizardClose.addEventListener('click', () => {
          wizard.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
