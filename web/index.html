<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:18px;border:1px solid var(--ring)}
    h1{margin:0 0 12px;font-size:28px}
    h2{margin:0 0 12px;font-size:18px}
    .palette{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;max-height:520px;overflow:auto;padding-right:4px;align-content:start}
    .palette{scrollbar-width:thin;scrollbar-color:var(--ring) transparent}
    .palette::-webkit-scrollbar{width:6px}
    .palette::-webkit-scrollbar-thumb{background:var(--ring);border-radius:999px}
    .pill{display:grid;grid-template-columns:auto minmax(0,1fr) auto;grid-template-rows:auto auto;align-items:center;gap:6px 10px;padding:10px 12px;border-radius:14px;background:#0b1527;border:1px solid var(--ring);cursor:pointer;min-height:0;transition:border-color .2s,box-shadow .2s,transform .2s}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .pill[aria-selected="true"]{border-color:var(--accent);box-shadow:0 0 0 1px rgba(56,189,248,.35)}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .dot{grid-column:1;grid-row:1/span 2;width:16px;height:16px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
    .dot.transparent{
      background-image:
        linear-gradient(45deg,#999 25%,transparent 25%),
        linear-gradient(-45deg,#999 25%,transparent 25%),
        linear-gradient(45deg,transparent 75%,#999 75%),
        linear-gradient(-45deg,transparent 75%,#999 75%);
      background-size:8px 8px;
      background-position:0 0,0 4px,4px -4px,-4px 0;
      background-color:#fff;
    }
    .title{grid-column:2;font-weight:600;font-size:15px;line-height:1.25}
    .sub{grid-column:2/4;grid-row:2;font-size:12px;color:var(--muted);line-height:1.25}
    .price{grid-column:3;grid-row:1;justify-self:end;font-weight:700;font-size:14px;color:var(--accent)}
    .row{display:flex;gap:12px;align-items:center}
    input[type="file"],input[type="text"],button{border-radius:10px;border:1px solid var(--ring);background:#0b1527;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px}
    .viewer{position:relative;height:520px;border-radius:16px;border:1px dashed var(--ring);background:#0b1527;overflow:hidden}
    .viewer.drag{border-color:var(--accent);color:var(--accent)}
    .viewer canvas{width:100%;height:100%;display:block}
    .viewer-message{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;text-align:center;color:var(--muted);pointer-events:none;padding:0 12px;font-size:14px;transition:opacity .3s}
    .viewer-message b{color:var(--text)}
    .viewer.has-model{border-style:solid}
    .viewer.has-model .viewer-message{opacity:0}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:16px}
    .stat{background:#0b1527;border:1px solid var(--ring);border-radius:14px;padding:12px}
    .stat-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}
    .stat-value{font-weight:600;font-size:18px;color:var(--text)}
    .stat-sub{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Dati e prezzi da Spoolman (€/kg). Costo macchina fisso lato server.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce mostra: <b>Materiale</b> — <span class="sub">Nome colore</span> — <b>€/kg</b>.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">
          <canvas id="viewerCanvas" aria-hidden="true"></canvas>
          <div id="viewerMessage" class="viewer-message">
            <b>Viewer 3D</b>
            <span>Trascina qui un file oppure usate i pulsanti sotto per caricare un modello STL/OBJ/3MF.</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>Stima tempi & costi</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip" />
        <button id="btnUpload">Carica</button>
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="flex:1;min-width:260px" />
        <button id="btnFetch">Calcola da URL</button>
      </div>
      <p class="hint">Dopo il caricamento scegli un materiale dalla palette; il prezzo €/kg arriva dalle <b>bobine</b>. Aggiornamento elenco ogni 60 s.</p>
      <div id="stats" class="stats" aria-live="polite">
        <div class="stat"><div class="stat-title">Volume modello</div><div id="statVolume" class="stat-value">-</div><div id="statDims" class="stat-sub"></div></div>
        <div class="stat"><div class="stat-title">Peso stimato</div><div id="statWeight" class="stat-value">-</div><div id="statFilament" class="stat-sub"></div></div>
        <div class="stat"><div class="stat-title">Tempo stimato</div><div id="statTime" class="stat-value">-</div><div id="statSpeed" class="stat-sub"></div></div>
        <div class="stat"><div class="stat-title">Costo materiale</div><div id="statMaterialCost" class="stat-value">-</div><div id="statPriceInfo" class="stat-sub"></div></div>
        <div class="stat"><div class="stat-title">Costo macchina</div><div id="statMachineCost" class="stat-value">-</div><div id="statHourly" class="stat-sub"></div></div>
        <div class="stat"><div class="stat-title">Totale stimato</div><div id="statTotal" class="stat-value">-</div><div id="statSummary" class="stat-sub"></div></div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.159.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/STLLoader.js";
    import { OBJLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/OBJLoader.js";
    import { ThreeMFLoader } from "https://unpkg.com/three@0.159.0/examples/jsm/loaders/3MFLoader.js";
    import { BufferGeometryUtils } from "https://unpkg.com/three@0.159.0/examples/jsm/utils/BufferGeometryUtils.js";

    // ---------- util colore accessibile ----------
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||"");
      return m ? {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)} : {r:127,g:127,b:127};
    }
    const BASIC = {
      "#000000":"Nero", "#FFFFFF":"Bianco", "#FF0000":"Rosso", "#00FF00":"Verde",
      "#0000FF":"Blu", "#FFFF00":"Giallo", "#FFA500":"Arancione", "#FFC0CB":"Rosa",
      "#800080":"Viola", "#A52A2A":"Marrone", "#808080":"Grigio", "#00FFFF":"Ciano",
      "#008000":"Verde scuro", "#ADD8E6":"Azzurro", "#FFD700":"Oro", "#8B4513":"Terra di Siena"
    };
    function nearestBasicName(hex){
      const {r,g,b}=hexToRgb(hex), entries=Object.entries(BASIC);
      let best=entries[0][0], dist=1e9;
      for(const [h] of entries){
        const c=hexToRgb(h); const d=(r-c.r)**2+(g-c.g)**2+(b-c.b)**2;
        if(d<dist){dist=d;best=h}
      }
      return BASIC[best];
    }

    // ---------- stato ----------
    const REFRESH_MS = 60000; // 60 s
    const MATERIAL_DENSITY = {
      "PLA": 1.24,
      "PLA+": 1.25,
      "PETG": 1.27,
      "ABS": 1.04,
      "ASA": 1.07,
      "TPU": 1.21,
      "FLEX": 1.21,
      "NYLON": 1.15,
      "PA": 1.14,
      "PC": 1.20,
      "HIPS": 1.04,
      "PP": 0.91,
      "PCTG": 1.27,
      "PVB": 1.19
    };
    const DEFAULT_DENSITY = 1.24; // g/cm3
    const INFILL_RATIO = 0.20;    // 20% infill standard
    const SHELL_RATIO = 0.25;     // perimetri/solidi pieni
    const EFFECTIVE_VOLUME_FACTOR = Math.min(0.95, INFILL_RATIO + SHELL_RATIO);
    const AVG_SPEED_MM_S = 45;    // mm/s estrusione media
    const TRAVEL_FACTOR = 1.25;   // fattore per movimenti a vuoto e pause

    let selectedKey = null;
    let paletteItems = [];
    let hourlyRate = 0;
    let currency = 'EUR';
    let currentModel = null;
    let viewerInitialized = false;
    let renderer = null;
    let scene = null;
    let camera = null;
    let controls = null;
    let mesh = null;
    let grid = null;

    const viewer = document.getElementById('viewer');
    const viewerCanvas = document.getElementById('viewerCanvas');
    const viewerMessage = document.getElementById('viewerMessage');

    const statVolume = document.getElementById('statVolume');
    const statDims = document.getElementById('statDims');
    const statWeight = document.getElementById('statWeight');
    const statFilament = document.getElementById('statFilament');
    const statTime = document.getElementById('statTime');
    const statSpeed = document.getElementById('statSpeed');
    const statMaterialCost = document.getElementById('statMaterialCost');
    const statPriceInfo = document.getElementById('statPriceInfo');
    const statMachineCost = document.getElementById('statMachineCost');
    const statHourly = document.getElementById('statHourly');
    const statTotal = document.getElementById('statTotal');
    const statSummary = document.getElementById('statSummary');

    function ensureViewer(){
      if(viewerInitialized) return;
      viewerInitialized = true;
      renderer = new THREE.WebGLRenderer({canvas: viewerCanvas, antialias: true, alpha: true});
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, viewer.clientWidth / Math.max(viewer.clientHeight, 1), 0.1, 5000);
      camera.position.set(120, 120, 120);
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.target.set(0, 0, 0);

      const hemi = new THREE.HemisphereLight(0xffffff, 0x1e1e1e, 0.85);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.6);
      dir.position.set(0.8, 1, 0.6);
      scene.add(dir);
      grid = new THREE.GridHelper(200, 20, 0x1f2937, 0x1f2937);
      grid.position.y = -0.0001;
      scene.add(grid);

      function resize(){
        const w = viewer.clientWidth || 1;
        const h = viewer.clientHeight || 1;
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      resize();
      window.addEventListener('resize', resize);

      (function animate(){
        requestAnimationFrame(animate);
        if(controls) controls.update();
        if(renderer && scene && camera){
          renderer.render(scene, camera);
        }
      })();
    }

    function resetStats(){
      statVolume.textContent = '-';
      statDims.textContent = '';
      statWeight.textContent = '-';
      statFilament.textContent = '';
      statTime.textContent = '-';
      statSpeed.textContent = '';
      statMaterialCost.textContent = '-';
      statPriceInfo.textContent = '';
      statMachineCost.textContent = '-';
      statHourly.textContent = '';
      statTotal.textContent = '-';
      statSummary.textContent = '';
    }

    function getSelectedSpool(){
      return paletteItems.find(p => p.key === selectedKey);
    }

    function densityForMaterial(mat){
      if(!mat) return DEFAULT_DENSITY;
      const key = mat.toString().trim().toUpperCase();
      if(MATERIAL_DENSITY[key] != null) return MATERIAL_DENSITY[key];
      const plain = key.replace(/[^A-Z]/g, '');
      for(const k of Object.keys(MATERIAL_DENSITY)){
        if(plain.includes(k)) return MATERIAL_DENSITY[k];
      }
      return DEFAULT_DENSITY;
    }

    function applyMaterialToMesh(){
      if(!mesh) return;
      const spool = getSelectedSpool();
      const hex = (spool && spool.color) ? spool.color : '#38bdf8';
      const color = new THREE.Color(hex);
      mesh.material.color.copy(color);
      mesh.material.transparent = !!(spool && spool.is_transparent);
      mesh.material.opacity = (spool && spool.is_transparent) ? 0.6 : 1;
      mesh.material.needsUpdate = true;
    }

    function updateEstimates(){
      resetStats();
      if(!currentModel){
        viewer.classList.remove('has-model');
        viewerMessage.innerHTML = '<b>Viewer 3D</b><span>Trascina qui un file oppure usa i pulsanti per caricarlo.</span>';
        return;
      }
      viewer.classList.add('has-model');
      const {name, volumeMM3, effectiveVolumeMM3, dimensions} = currentModel;
      const spool = getSelectedSpool();
      const density = densityForMaterial(spool ? spool.material : null);
      const diameter = spool && spool.diameter_mm ? Number(spool.diameter_mm) : 1.75;
      const area = Math.PI * Math.pow(diameter / 2, 2);
      const weightG = (effectiveVolumeMM3 / 1000) * density;
      const lengthMM = area > 0 ? (effectiveVolumeMM3 / area) : 0;
      const timeHours = (lengthMM / AVG_SPEED_MM_S) / 3600 * TRAVEL_FACTOR;
      const pricePerKg = spool && spool.price_per_kg != null ? Number(spool.price_per_kg) : null;
      const materialCost = pricePerKg != null ? (weightG / 1000) * pricePerKg : null;
      const machineCost = hourlyRate ? timeHours * hourlyRate : null;
      const currenciesMatch = !(spool && spool.currency && currency && spool.currency !== currency);
      const totalCost = currenciesMatch ? (materialCost || 0) + (machineCost || 0) : null;
      const colName = spool ? (spool.color_name || nearestBasicName(spool.color)) : null;

      statVolume.textContent = `${(volumeMM3 / 1000).toFixed(2)} cm³`;
      statDims.textContent = `Dim: ${dimensions.x.toFixed(1)} × ${dimensions.y.toFixed(1)} × ${dimensions.z.toFixed(1)} mm`;
      statWeight.textContent = `${weightG.toFixed(1)} g`;
      statFilament.textContent = `Lunghezza ~ ${(lengthMM / 1000).toFixed(2)} m (Ø ${diameter.toFixed(2)} mm)`;
      statTime.textContent = `${timeHours.toFixed(2)} h`;
      statSpeed.textContent = `Velocità media ${AVG_SPEED_MM_S} mm/s`;

      if(materialCost != null){
        statMaterialCost.textContent = `${materialCost.toFixed(2)} ${spool.currency || currency}`;
        statPriceInfo.textContent = `Prezzo spool ${pricePerKg.toFixed(2)} ${spool.currency || currency}/kg`;
      } else {
        statMaterialCost.textContent = 'n/d';
        statPriceInfo.textContent = 'Prezzo bobina non disponibile';
      }

      if(machineCost != null){
        statMachineCost.textContent = `${machineCost.toFixed(2)} ${currency}`;
        statHourly.textContent = `Tariffa ${hourlyRate.toFixed(2)} ${currency}/h`;
      } else {
        statMachineCost.textContent = hourlyRate ? `${(timeHours * hourlyRate).toFixed(2)} ${currency}` : 'n/d';
        statHourly.textContent = hourlyRate ? `Tariffa ${hourlyRate.toFixed(2)} ${currency}/h` : 'Tariffa non impostata';
      }

      if(totalCost != null){
        const finalCurrency = spool && spool.currency ? spool.currency : currency;
        statTotal.textContent = `${totalCost.toFixed(2)} ${finalCurrency}`;
        statSummary.textContent = spool ? `${spool.material || 'Materiale'} — ${colName || 'Colore'} — ${name}` : 'Seleziona un materiale dalla palette per i costi.';
      } else {
        statTotal.textContent = 'n/d';
        statSummary.textContent = spool ? `Valuta bobina (${spool.currency}) diversa dalla tariffa (${currency}).` : 'Seleziona un materiale dalla palette per i costi.';
      }

      viewerMessage.innerHTML = `<b>${name}</b><span>Modello caricato. Usa il mouse per orbitare e la rotellina per zoom.</span>`;
      applyMaterialToMesh();
    }

    function clearMesh(){
      if(mesh){
        scene.remove(mesh);
        mesh.geometry.dispose();
        mesh.material.dispose();
        mesh = null;
      }
    }

    function computeVolume(geometry){
      const g = geometry.index ? geometry.toNonIndexed() : geometry.clone();
      const pos = g.attributes.position.array;
      const v1 = new THREE.Vector3();
      const v2 = new THREE.Vector3();
      const v3 = new THREE.Vector3();
      const cross = new THREE.Vector3();
      let volume = 0;
      for(let i=0;i<pos.length;i+=9){
        v1.set(pos[i], pos[i+1], pos[i+2]);
        v2.set(pos[i+3], pos[i+4], pos[i+5]);
        v3.set(pos[i+6], pos[i+7], pos[i+8]);
        volume += v1.dot(cross.copy(v2).cross(v3));
      }
      return Math.abs(volume) / 6.0;
    }

    function centerGeometry(geometry){
      geometry.computeBoundingBox();
      const center = geometry.boundingBox.getCenter(new THREE.Vector3());
      geometry.translate(-center.x, -center.y, -center.z);
      geometry.computeBoundingBox();
      geometry.computeBoundingSphere();
    }

    function adjustView(geometry){
      if(!geometry.boundingSphere) geometry.computeBoundingSphere();
      const radius = Math.max(geometry.boundingSphere.radius || 1, 1);
      const dist = radius * 2.6;
      camera.position.set(dist, dist * 0.9, dist);
      controls.target.set(0, 0, 0);
      controls.update();
      if(grid){
        const scale = Math.max(1, radius / 80);
        grid.scale.set(scale, 1, scale);
      }
    }

    async function loadModel(url, name){
      ensureViewer();
      viewerMessage.innerHTML = `<b>${name}</b><span>Caricamento in corso...</span>`;
      viewer.classList.remove('has-model');
      resetStats();

      const manager = new THREE.LoadingManager();
      const extMatch = (name || url).split('.').pop().toLowerCase();
      let loader = null;
      if(extMatch === 'stl') loader = new STLLoader(manager);
      else if(extMatch === 'obj') loader = new OBJLoader(manager);
      else if(extMatch === '3mf') loader = new ThreeMFLoader(manager);
      else throw new Error(`Estensione non supportata: ${extMatch}`);

      return new Promise((resolve, reject) => {
        loader.load(url, object => {
          let geometry = null;
          if(object.isBufferGeometry || object.isGeometry){
            geometry = object.clone();
          } else if(object.isGroup || object.isObject3D){
            const geoms = [];
            object.traverse(child => {
              if(child.isMesh && child.geometry){
                const g = child.geometry.clone();
                geoms.push(g.index ? g.toNonIndexed() : g);
              }
            });
            if(geoms.length){
              geometry = BufferGeometryUtils.mergeGeometries(geoms, true);
            }
          }
          if(!geometry){
            reject(new Error('Impossibile estrarre la geometria dal file.'));
            return;
          }
          if(geometry.index){
            geometry = geometry.toNonIndexed();
          }
          geometry.computeVertexNormals();
          centerGeometry(geometry);
          const volume = computeVolume(geometry);
          const dims = geometry.boundingBox.getSize(new THREE.Vector3());
          clearMesh();
          mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({color: 0x38bdf8, metalness: 0.1, roughness: 0.75, transparent: false}));
          scene.add(mesh);
          adjustView(geometry);

          const effective = volume * EFFECTIVE_VOLUME_FACTOR;
          currentModel = {
            name,
            volumeMM3: volume,
            effectiveVolumeMM3: effective,
            dimensions: dims
          };
          updateEstimates();
          resolve();
        }, undefined, err => {
          viewerMessage.innerHTML = `<b>${name}</b><span>Errore durante il caricamento.</span>`;
          currentModel = null;
          clearMesh();
          reject(err);
        });
      });
    }

    // ---------- palette ----------
    async function loadPalette(){
      const res = await fetch('/inventory?nocache='+Date.now());
      const data = await res.json();
      paletteItems = Array.isArray(data.items) ? data.items.slice() : [];
      hourlyRate = data.hourly_rate != null ? Number(data.hourly_rate) : 0;
      currency = data.currency || 'EUR';
      if(selectedKey && !paletteItems.some(p => p.key === selectedKey)){
        selectedKey = null;
      }
      renderPalette(paletteItems);
      updateEstimates();
    }

    function renderPalette(items){
      const box = document.getElementById('palette');
      box.innerHTML = '';
      items
        .slice()
        .sort((a,b)=> (a.material||'').localeCompare(b.material||'') || (a.color||'').localeCompare(b.color||'' ) )
        .forEach(it=>{
          const hex = (it.color || '#777777').toUpperCase();
          const price = (it.price_per_kg!=null) ? `${Number(it.price_per_kg).toFixed(2)} ${it.currency}/kg` : 'n/d';
          const colorName = it.color_name || nearestBasicName(hex);

          const row = document.createElement('div');
          row.className='pill';
          row.setAttribute('role','option');
          row.setAttribute('aria-label', `${it.material}, ${colorName}, ${price}`);
          row.setAttribute('aria-selected', selectedKey===it.key ? 'true' : 'false');
          row.tabIndex = 0;
          const selectRow = ()=>{
            selectedKey = it.key;
            [...box.children].forEach(c=>c.setAttribute('aria-selected','false'));
            row.setAttribute('aria-selected','true');
            applyMaterialToMesh();
            updateEstimates();
          };
          row.onclick = selectRow;
          row.onkeydown = (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); selectRow(); } };

          const dot = document.createElement('span'); dot.className='dot' + (it.is_transparent ? ' transparent' : '');
          if(!it.is_transparent){ dot.style.backgroundColor = hex; }
          dot.title = colorName; dot.setAttribute('aria-hidden','true');

          const title = document.createElement('div'); title.className='title'; title.textContent = it.material || 'n/d';
          const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = price;
          const sub = document.createElement('div'); sub.className='sub'; sub.textContent = colorName;

          row.appendChild(dot);
          row.appendChild(title);
          row.appendChild(priceEl);
          row.appendChild(sub);
          box.appendChild(row);
        });

      const active = [...box.children].find(c => c.getAttribute('aria-selected') === 'true');
      if(!active && box.children.length){
        box.children[0].click();
      }
    }

    // ---------- upload / fetch ----------
    async function uploadFileOrBlob(file){
      const fd = new FormData(); fd.append('file', file);
      const r = await fetch('/upload_model', {method:'POST', body: fd});
      if(!r.ok){ alert('Upload fallito'); return; }
      const j = await r.json();
      const url = new URL(j.viewer_url, window.location.origin).href;
      try {
        await loadModel(url, j.filename);
      } catch (err){
        console.error(err);
        alert('Impossibile visualizzare il modello.');
      }
    }

    async function uploadFile(){
      const f = document.getElementById('file').files[0];
      if(!f){ alert('Seleziona un file'); return; }
      await uploadFileOrBlob(f);
    }

    async function fetchFromUrl(){
      const url = document.getElementById('url').value.trim();
      if(!url){ alert('Inserisci una URL'); return; }
      const r = await fetch('/fetch_model', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url})});
      const j = await r.json();
      if(j.viewer_url){
        try {
          const abs = new URL(j.viewer_url, window.location.origin).href;
          await loadModel(abs, j.filename);
        } catch (err){
          console.error(err);
          alert('Impossibile visualizzare il modello.');
        }
      } else {
        alert('Nessun modello trovato');
      }
    }

    // drag & drop
    viewer.addEventListener('dragover', e => { e.preventDefault(); viewer.classList.add('drag'); });
    viewer.addEventListener('dragleave', () => viewer.classList.remove('drag'));
    viewer.addEventListener('drop', e => {
      e.preventDefault(); viewer.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){ uploadFileOrBlob(f); }
    });

    // ---------- init ----------
    document.getElementById('btnUpload').onclick = uploadFile;
    document.getElementById('btnFetch').onclick  = fetchFromUrl;
    ensureViewer();
    loadPalette();
    setInterval(loadPalette, REFRESH_MS);
  </script>
</body>
</html>
