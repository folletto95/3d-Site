<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1629;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8;--pill:#111827}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .h1{font-size:clamp(24px,3.2vw,36px);font-weight:800;margin:0 0 8px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:16px;padding:14px 14px}
    .sec{margin-top:14px}

    /* Palette */
    .filter{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #223047;background:#0a1323;color:var(--text)}
    .list{margin-top:12px;border-top:1px solid #152035}
    .row{display:flex;align-items:center;gap:14px;padding:14px;border-bottom:1px solid #152035;border-radius:12px}
    .row:hover{background:#0c1931}
    .left{display:flex;align-items:center;gap:14px;min-width:0}
    .right{margin-left:auto;font-weight:700;white-space:nowrap}
    .mat{font-weight:700}
    .sub{color:var(--muted);font-size:14px}

    /* Swatch */
    .swatch{width:28px;height:28px;border-radius:999px;border:2px solid #1b2a44;flex:0 0 auto;position:relative;overflow:hidden;box-shadow:0 0 0 2px #0a1323}
    .swatch.transparent::before{content:"";position:absolute;inset:0;background:
      conic-gradient(#c7c7c7 0 25%,#ededed 0 50%,#c7c7c7 0 75%,#ededed 0 100%);
      background-size:10px 10px;filter:contrast(1.1)}
    .swatch.transparent::after{content:"";position:absolute;inset:0;background:linear-gradient(45deg,rgba(0,0,0,.15),rgba(0,0,0,0))}

    /* Helper badges */
    .pill{background:var(--pill);border:1px solid #1f2937;border-radius:999px;padding:2px 8px;font-size:12px;color:#9fb1c9}
    .head{display:flex;justify-content:space-between;align-items:center}
    .guide{padding:6px 10px;border-radius:10px;border:1px solid #24324a;background:#0c1730;color:#b8c6dc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 class="h1">Magazzino Filamenti & Stima</h1>
      <a class="guide" href="#">Guida</a>
    </div>
    <p class="muted">Dati e prezzi da Spoolman (€/kg). Costo macchina fisso lato server. La stima usa CuraEngine.</p>

    <section class="card sec">
      <h2 style="margin:0 0 10px">Palette (seleziona materiale)</h2>
      <input id="q" class="filter" placeholder="Filtra per materiale o colore" />
      <div id="palette" class="list" role="list"></div>
      <p class="muted" style="margin:10px 0 0">Ogni voce: <b>Materiale</b> — <span id="legend">Nome colore</span> — <span>€/kg</span>. Aggiornamento ogni <span id="refresh">60</span> s.</p>
    </section>

    <!-- Il resto della pagina (viewer, upload, stima) resta invariato nel tuo progetto -->
  </div>

  <script>
    const REFRESH_SEC = 60;
    const API_URL = '/api/spools';

    // Override esatti per gli HEX noti (preferenza assoluta)
    const HEX_OVERRIDES = {
      '#FFFFFF':'Bianco',
      '#000000':'Nero',
      '#020000':'Nero',
      '#A6A9AA':'Grigio',
      '#0A2989':'Blu',
      '#5E43B7':'Viola',
      '#FF9016':'Arancione',
      '#00AE42':'Verde',
      '#F4EE2A':'Giallo',
      '#E4BD68':'Oro',          // ⇦ specifica richiesta
      '#EC008C':'Fucsia',       // rosa acceso/magenta
      '#F5547C':'Rosa',         // rosa/corallo
      '#9D432C':'Mattone',      // rosso bruno
      '#C12E1F':'Rosso',
      '#F7E6DE':'Rosa chiaro'   // non rosso: molto chiaro/pelle
    };

    function clamp01(x){return Math.max(0,Math.min(1,x));}
    function hexToRgb(hex){
      hex = hex.trim();
      if(!hex) return null;
      if(hex[0] !== '#') hex = '#' + hex;
      if(hex.length === 4){ hex = '#' + [...hex.slice(1)].map(c=>c+c).join(''); }
      if(hex.length !== 7) return null;
      const n = parseInt(hex.slice(1),16);
      return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
    }
    function rgbToHsl({r,g,b}){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,l=(max+min)/2;
      if(max===min){ h=0; s=0; }
      else{
        const d=max-min;
        s = l>0.5? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d+(g<b?6:0); break;
          case g: h=(b-r)/d+2; break;
          case b: h=(r-g)/d+4; break;
        }
        h*=60;
      }
      return {h, s, l};
    }

    function basicItalianNameFromHSL(hsl){
      const {h,s,l} = hsl; const S=s, L=l;
      if(L>=0.94 && S<=0.1) return 'Bianco';
      if(L<=0.08) return 'Nero';
      if(S<=0.10) return 'Grigio';
      // Oro: intorno a 45°, saturazione medio-alta, luminanza media
      if(h>=36 && h<=56 && S>=0.35 && L>=0.40 && L<=0.75) return 'Oro';
      if(h<12 || h>=345) return 'Rosso';
      if(h<28) return 'Arancione';
      if(h<45) return 'Giallo';
      if(h<80) return 'Verde';
      if(h<190) return 'Ciano';
      if(h<250) return 'Blu';
      if(h<290) return 'Viola';
      if(h<330) return 'Magenta';
      return 'Rosa';
    }

    function humanColorName(hex){
      if(!hex) return null;
      const key = hex.toUpperCase();
      if(HEX_OVERRIDES[key]) return HEX_OVERRIDES[key];
      const rgb = hexToRgb(key); if(!rgb) return null;
      const hsl = rgbToHsl(rgb);
      return basicItalianNameFromHSL(hsl);
    }

    function normalizeItem(it){
      const hex = (it.color_hex || it.hex || '').toString();
      const normHex = hex && hex[0] === '#' ? hex : (hex ? '#' + hex : '');
      const upper = normHex.toUpperCase();
      const isTransparent = !!it.is_transparent;
      // Nome colore: priorità ai dati backend
      let name = it.color_name || it.name || humanColorName(upper) || 'Sconosciuto';
      // Se trasparente, etichettiamo come "Trasparente" se il backend non lo ha già messo
      if(isTransparent && !/trasparen/i.test(name)) name = 'Trasparente';
      // Chiave stabile per selezione
      const key = `${it.material||'mat'}|${upper||'nohex'}|${name}`;
      return {
        ...it,
        color_hex: upper||null,
        color_name: name,
        is_transparent: isTransparent,
        key
      };
    }

    function renderPalette(items){
      const root = document.getElementById('palette');
      root.innerHTML = '';
      const q = document.getElementById('q').value.trim().toLowerCase();
      const filtered = items.filter(it=>{
        const hay = `${it.material||''} ${it.color_name||''}`.toLowerCase();
        return !q || hay.includes(q);
      });
      for(const it of filtered){
        const row = document.createElement('div'); row.className = 'row'; row.setAttribute('role','listitem');
        const sw = document.createElement('div'); sw.className = 'swatch';
        if(it.is_transparent){ sw.classList.add('transparent'); }
        if(it.color_hex){ sw.style.background = it.color_hex; }
        const left = document.createElement('div'); left.className = 'left';
        left.appendChild(sw);
        const texts = document.createElement('div');
        const mat = document.createElement('div'); mat.className='mat'; mat.textContent = it.material||'—';
        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = it.color_name||'—';
        texts.appendChild(mat); texts.appendChild(sub);
        left.appendChild(texts);
        const price = document.createElement('div'); price.className='right';
        price.textContent = (it.price_per_kg!=null? `${Number(it.price_per_kg).toFixed(2)} EUR/kg` : '—');
        row.appendChild(left); row.appendChild(price);
        root.appendChild(row);
      }
    }

    async function loadAndRender(){
      try{
        const r = await fetch(API_URL, {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        const raw = Array.isArray(data)? data : (data.items || []);
        const items = raw.map(normalizeItem);
        window.__PALETTE = items; // debug
        renderPalette(items);
      }catch(err){
        console.error('Errore caricamento palette', err);
        const root = document.getElementById('palette');
        root.innerHTML = `<div class="sub" style="padding:12px">Errore nel leggere i dati: ${String(err)}</div>`;
      }
    }

    document.getElementById('q').addEventListener('input', ()=>{
      if(window.__PALETTE) renderPalette(window.__PALETTE);
    });

    loadAndRender();
    setInterval(loadAndRender, REFRESH_SEC*1000);
  </script>
</body>
</html>
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1629;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8;--pill:#111827}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .h1{font-size:clamp(24px,3.2vw,36px);font-weight:800;margin:0 0 8px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:16px;padding:14px 14px}
    .sec{margin-top:14px}

    /* Palette */
    .filter{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #223047;background:#0a1323;color:var(--text)}
    .list{margin-top:12px;border-top:1px solid #152035}
    .row{display:flex;align-items:center;gap:14px;padding:14px;border-bottom:1px solid #152035;border-radius:12px}
    .row:hover{background:#0c1931}
    .left{display:flex;align-items:center;gap:14px;min-width:0}
    .right{margin-left:auto;font-weight:700;white-space:nowrap}
    .mat{font-weight:700}
    .sub{color:var(--muted);font-size:14px}

    /* Swatch */
    .swatch{width:28px;height:28px;border-radius:999px;border:2px solid #1b2a44;flex:0 0 auto;position:relative;overflow:hidden;box-shadow:0 0 0 2px #0a1323}
    .swatch.transparent::before{content:"";position:absolute;inset:0;background:
      conic-gradient(#c7c7c7 0 25%,#ededed 0 50%,#c7c7c7 0 75%,#ededed 0 100%);
      background-size:10px 10px;filter:contrast(1.1)}
    .swatch.transparent::after{content:"";position:absolute;inset:0;background:linear-gradient(45deg,rgba(0,0,0,.15),rgba(0,0,0,0))}

    /* Helper badges */
    .pill{background:var(--pill);border:1px solid #1f2937;border-radius:999px;padding:2px 8px;font-size:12px;color:#9fb1c9}
    .head{display:flex;justify-content:space-between;align-items:center}
    .guide{padding:6px 10px;border-radius:10px;border:1px solid #24324a;background:#0c1730;color:#b8c6dc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 class="h1">Magazzino Filamenti & Stima</h1>
      <a class="guide" href="#">Guida</a>
    </div>
    <p class="muted">Dati e prezzi da Spoolman (€/kg). Costo macchina fisso lato server. La stima usa CuraEngine.</p>

    <section class="card sec">
      <h2 style="margin:0 0 10px">Palette (seleziona materiale)</h2>
      <input id="q" class="filter" placeholder="Filtra per materiale o colore" />
      <div id="palette" class="list" role="list"></div>
      <p class="muted" style="margin:10px 0 0">Ogni voce: <b>Materiale</b> — <span id="legend">Nome colore</span> — <span>€/kg</span>. Aggiornamento ogni <span id="refresh">60</span> s.</p>
    </section>

    <!-- Il resto della pagina (viewer, upload, stima) resta invariato nel tuo progetto -->
  </div>

  <script>
    const REFRESH_SEC = 60;
    const API_URL = '/api/spools';

    // Override esatti per gli HEX noti (preferenza assoluta)
    const HEX_OVERRIDES = {
      '#FFFFFF':'Bianco',
      '#000000':'Nero',
      '#020000':'Nero',
      '#A6A9AA':'Grigio',
      '#0A2989':'Blu',
      '#5E43B7':'Viola',
      '#FF9016':'Arancione',
      '#00AE42':'Verde',
      '#F4EE2A':'Giallo',
      '#E4BD68':'Oro',          // ⇦ specifica richiesta
      '#EC008C':'Fucsia',       // rosa acceso/magenta
      '#F5547C':'Rosa',         // rosa/corallo
      '#9D432C':'Mattone',      // rosso bruno
      '#C12E1F':'Rosso',
      '#F7E6DE':'Rosa chiaro'   // non rosso: molto chiaro/pelle
    };

    function clamp01(x){return Math.max(0,Math.min(1,x));}
    function hexToRgb(hex){
      hex = hex.trim();
      if(!hex) return null;
      if(hex[0] !== '#') hex = '#' + hex;
      if(hex.length === 4){ hex = '#' + [...hex.slice(1)].map(c=>c+c).join(''); }
      if(hex.length !== 7) return null;
      const n = parseInt(hex.slice(1),16);
      return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
    }
    function rgbToHsl({r,g,b}){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,l=(max+min)/2;
      if(max===min){ h=0; s=0; }
      else{
        const d=max-min;
        s = l>0.5? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d+(g<b?6:0); break;
          case g: h=(b-r)/d+2; break;
          case b: h=(r-g)/d+4; break;
        }
        h*=60;
      }
      return {h, s, l};
    }

    function basicItalianNameFromHSL(hsl){
      const {h,s,l} = hsl; const S=s, L=l;
      if(L>=0.94 && S<=0.1) return 'Bianco';
      if(L<=0.08) return 'Nero';
      if(S<=0.10) return 'Grigio';
      // Oro: intorno a 45°, saturazione medio-alta, luminanza media
      if(h>=36 && h<=56 && S>=0.35 && L>=0.40 && L<=0.75) return 'Oro';
      if(h<12 || h>=345) return 'Rosso';
      if(h<28) return 'Arancione';
      if(h<45) return 'Giallo';
      if(h<80) return 'Verde';
      if(h<190) return 'Ciano';
      if(h<250) return 'Blu';
      if(h<290) return 'Viola';
      if(h<330) return 'Magenta';
      return 'Rosa';
    }

    function humanColorName(hex){
      if(!hex) return null;
      const key = hex.toUpperCase();
      if(HEX_OVERRIDES[key]) return HEX_OVERRIDES[key];
      const rgb = hexToRgb(key); if(!rgb) return null;
      const hsl = rgbToHsl(rgb);
      return basicItalianNameFromHSL(hsl);
    }

    function normalizeItem(it){
      const hex = (it.color_hex || it.hex || '').toString();
      const normHex = hex && hex[0] === '#' ? hex : (hex ? '#' + hex : '');
      const upper = normHex.toUpperCase();
      const isTransparent = !!it.is_transparent;
      // Nome colore: priorità ai dati backend
      let name = it.color_name || it.name || humanColorName(upper) || 'Sconosciuto';
      // Se trasparente, etichettiamo come "Trasparente" se il backend non lo ha già messo
      if(isTransparent && !/trasparen/i.test(name)) name = 'Trasparente';
      // Chiave stabile per selezione
      const key = `${it.material||'mat'}|${upper||'nohex'}|${name}`;
      return {
        ...it,
        color_hex: upper||null,
        color_name: name,
        is_transparent: isTransparent,
        key
      };
    }

    function renderPalette(items){
      const root = document.getElementById('palette');
      root.innerHTML = '';
      const q = document.getElementById('q').value.trim().toLowerCase();
      const filtered = items.filter(it=>{
        const hay = `${it.material||''} ${it.color_name||''}`.toLowerCase();
        return !q || hay.includes(q);
      });
      for(const it of filtered){
        const row = document.createElement('div'); row.className = 'row'; row.setAttribute('role','listitem');
        const sw = document.createElement('div'); sw.className = 'swatch';
        if(it.is_transparent){ sw.classList.add('transparent'); }
        if(it.color_hex){ sw.style.background = it.color_hex; }
        const left = document.createElement('div'); left.className = 'left';
        left.appendChild(sw);
        const texts = document.createElement('div');
        const mat = document.createElement('div'); mat.className='mat'; mat.textContent = it.material||'—';
        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = it.color_name||'—';
        texts.appendChild(mat); texts.appendChild(sub);
        left.appendChild(texts);
        const price = document.createElement('div'); price.className='right';
        price.textContent = (it.price_per_kg!=null? `${Number(it.price_per_kg).toFixed(2)} EUR/kg` : '—');
        row.appendChild(left); row.appendChild(price);
        root.appendChild(row);
      }
    }

    async function loadAndRender(){
      try{
        const r = await fetch(API_URL, {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        const raw = Array.isArray(data)? data : (data.items || []);
        const items = raw.map(normalizeItem);
        window.__PALETTE = items; // debug
        renderPalette(items);
      }catch(err){
        console.error('Errore caricamento palette', err);
        const root = document.getElementById('palette');
        root.innerHTML = `<div class="sub" style="padding:12px">Errore nel leggere i dati: ${String(err)}</div>`;
      }
    }

    document.getElementById('q').addEventListener('input', ()=>{
      if(window.__PALETTE) renderPalette(window.__PALETTE);
    });

    loadAndRender();
    setInterval(loadAndRender, REFRESH_SEC*1000);
  </script>
</body>
</html>
