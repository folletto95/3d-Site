<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:18px;border:1px solid var(--ring)}
    h1{margin:0 0 12px;font-size:28px}
    h2{margin:0 0 12px;font-size:18px}
    .palette{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;max-height:520px;overflow:auto;padding-right:4px;align-content:start}
    .palette{scrollbar-width:thin;scrollbar-color:var(--ring) transparent}
    .palette::-webkit-scrollbar{width:6px}
    .palette::-webkit-scrollbar-thumb{background:var(--ring);border-radius:999px}
    .pill{display:grid;grid-template-columns:auto minmax(0,1fr) auto;grid-template-rows:auto auto;align-items:center;gap:6px 10px;padding:10px 12px;border-radius:14px;background:#0b1527;border:1px solid var(--ring);cursor:pointer;min-height:0;transition:border-color .2s,box-shadow .2s,transform .2s}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .pill[aria-selected="true"]{border-color:var(--accent);box-shadow:0 0 0 1px rgba(56,189,248,.35)}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .dot{grid-column:1;grid-row:1/span 2;width:16px;height:16px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
    .dot.transparent{
      background-image:
        linear-gradient(45deg,#999 25%,transparent 25%),
        linear-gradient(-45deg,#999 25%,transparent 25%),
        linear-gradient(45deg,transparent 75%,#999 75%),
        linear-gradient(-45deg,transparent 75%,#999 75%);
      background-size:8px 8px;
      background-position:0 0,0 4px,4px -4px,-4px 0;
      background-color:#fff;
    }
    .title{grid-column:2;font-weight:600;font-size:15px;line-height:1.25}
    .sub{grid-column:2/4;grid-row:2;font-size:12px;color:var(--muted);line-height:1.25}
    .price{grid-column:3;grid-row:1;justify-self:end;font-weight:700;font-size:14px;color:var(--accent)}
    .row{display:flex;gap:12px;align-items:center}
    input[type="file"],input[type="text"],button{border-radius:10px;border:1px solid var(--ring);background:#0b1527;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px}
    .viewer{height:520px;border-radius:16px;border:1px dashed var(--ring);display:flex;align-items:center;justify-content:center;color:var(--muted)}
    .viewer.drag{border-color:var(--accent); color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Dati e prezzi da Spoolman (€/kg). Costo macchina fisso lato server.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce mostra: <b>Materiale</b> — <span class="sub">Nome colore</span> — <b>€/kg</b>.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">Trascina qui un file o caricalo dal pulsante sotto.</div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>Stima tempi & costi</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip" />
        <button id="btnUpload">Carica</button>
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="flex:1;min-width:260px" />
        <button id="btnFetch">Calcola da URL</button>
      </div>
      <p class="hint">Dopo il caricamento scegli un materiale dalla palette; il prezzo €/kg arriva dalle <b>bobine</b>. Aggiornamento elenco ogni 60 s.</p>
    </div>
  </div>

  <script>
    // ---------- util colore accessibile ----------
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||"");
      return m ? {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)} : {r:127,g:127,b:127};
    }
    const BASIC = {
      "#000000":"Nero", "#FFFFFF":"Bianco", "#FF0000":"Rosso", "#00FF00":"Verde",
      "#0000FF":"Blu", "#FFFF00":"Giallo", "#FFA500":"Arancione", "#FFC0CB":"Rosa",
      "#800080":"Viola", "#A52A2A":"Marrone", "#808080":"Grigio", "#00FFFF":"Ciano",
      "#008000":"Verde scuro", "#ADD8E6":"Azzurro", "#FFD700":"Oro", "#8B4513":"Terra di Siena"
    };
    function nearestBasicName(hex){
      const {r,g,b}=hexToRgb(hex), entries=Object.entries(BASIC);
      let best=entries[0][0], dist=1e9;
      for(const [h] of entries){
        const c=hexToRgb(h); const d=(r-c.r)**2+(g-c.g)**2+(b-c.b)**2;
        if(d<dist){dist=d;best=h}
      }
      return BASIC[best];
    }

    // ---------- stato ----------
    let selectedKey = null;
    const REFRESH_MS = 60000; // 60 s

    // ---------- palette ----------
    async function loadPalette(){
      const res = await fetch('/inventory?nocache='+Date.now());
      const data = await res.json();
      renderPalette(data.items || []);
    }

    function renderPalette(items){
      const box = document.getElementById('palette');
      box.innerHTML = '';
      items
        .sort((a,b)=> (a.material||'').localeCompare(b.material||'') || (a.color||'').localeCompare(b.color||'' ) )
        .forEach(it=>{
          const hex = (it.color || '#777777').toUpperCase();
          const price = (it.price_per_kg!=null) ? `${it.price_per_kg.toFixed(2)} ${it.currency}/kg` : 'n/d';
          const colorName = it.color_name || nearestBasicName(hex);

          const row = document.createElement('div');
          row.className='pill';
          row.setAttribute('role','option');
          row.setAttribute('aria-label', `${it.material}, ${colorName}, ${price}`);
          row.setAttribute('aria-selected', selectedKey===it.key ? 'true' : 'false');
          row.tabIndex = 0;
          const selectRow = ()=>{ selectedKey = it.key; [...box.children].forEach(c=>c.setAttribute('aria-selected','false')); row.setAttribute('aria-selected','true'); };
          row.onclick = selectRow;
          row.onkeydown = (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); selectRow(); } };

          const dot = document.createElement('span'); dot.className='dot' + (it.is_transparent ? ' transparent' : '');
          if(!it.is_transparent){ dot.style.backgroundColor = hex; }
          dot.title = colorName; dot.setAttribute('aria-hidden','true');

          const title = document.createElement('div'); title.className='title'; title.textContent = it.material || 'n/d';
          const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = price;
          const sub = document.createElement('div'); sub.className='sub'; sub.textContent = colorName;

          row.appendChild(dot);
          row.appendChild(title);
          row.appendChild(priceEl);
          row.appendChild(sub);
          box.appendChild(row);
        });
    }

    // ---------- upload / fetch ----------
    async function uploadFileOrBlob(file){
      const fd = new FormData(); fd.append('file', file);
      const r = await fetch('/upload_model', {method:'POST', body: fd});
      if(!r.ok){ alert('Upload fallito'); return; }
      const j = await r.json();
      showViewer(j.viewer_url, j.filename);
    }

    async function uploadFile(){
      const f = document.getElementById('file').files[0];
      if(!f){ alert('Seleziona un file'); return; }
      uploadFileOrBlob(f);
    }

    async function fetchFromUrl(){
      const url = document.getElementById('url').value.trim();
      if(!url){ alert('Inserisci una URL'); return; }
      const r = await fetch('/fetch_model', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url})});
      const j = await r.json();
      if(j.viewer_url){ showViewer(j.viewer_url, j.filename); } else { alert('Nessun modello trovato'); }
    }

    // drag & drop
    const viewer = document.getElementById('viewer');
    viewer.addEventListener('dragover', e => { e.preventDefault(); viewer.classList.add('drag'); });
    viewer.addEventListener('dragleave', () => viewer.classList.remove('drag'));
    viewer.addEventListener('drop', e => {
      e.preventDefault(); viewer.classList.remove('drag');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){ uploadFileOrBlob(f); }
    });

    function showViewer(path, name){
      const v = document.getElementById('viewer');
      v.innerHTML = `Caricato: <b>${name}</b><br><span class="hint">Anteprima 3D in arrivo (per ora link diretto):</span><br><a href="${path}" target="_blank" style="color:var(--accent)">${path}</a>`;
    }

    // ---------- init ----------
    document.getElementById('btnUpload').onclick = uploadFile;
    document.getElementById('btnFetch').onclick  = fetchFromUrl;
    loadPalette();
    setInterval(loadPalette, REFRESH_MS);
  </script>
</body>
</html>
