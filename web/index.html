<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:18px;border:1px solid var(--ring)}
    h1{margin:0 0 12px;font-size:28px}
    h2{margin:0 0 12px;font-size:18px}
    .palette{display:flex;flex-direction:column;gap:10px;max-height:460px;overflow:auto;padding-right:6px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-radius:16px;background:#0b1527;border:1px solid var(--ring);cursor:pointer}
    .pill[aria-selected="true"]{outline:2px solid var(--accent)}
    .left{display:flex;align-items:center;gap:12px}
    .dot{width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
    .dot.transparent{
      background-image:
        linear-gradient(45deg,#999 25%,transparent 25%),
        linear-gradient(-45deg,#999 25%,transparent 25%),
        linear-gradient(45deg,transparent 75%,#999 75%),
        linear-gradient(-45deg,transparent 75%,#999 75%);
      background-size:8px 8px; background-position:0 0,0 4px,4px -4px,-4px 0; background-color:#fff;
    }
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .price{font-weight:800}
    .row{display:flex;gap:12px;align-items:center}
    input[type="file"],input[type="text"],select,button{border-radius:10px;border:1px solid var(--ring);background:#0b1527;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px}
    .viewer{height:460px;border-radius:16px;border:1px dashed var(--ring);display:flex;align-items:center;justify-content:center;color:var(--muted);position:relative;overflow:hidden}
    .viewer.drag{border-color:var(--accent); color:var(--accent)}
    .spinner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .spin{width:28px;height:28px;border-radius:50%;border:3px solid #567;border-top-color:#9df;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(1turn)}}
    .canvas-wrap{position:absolute;inset:0}
    .est{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px;margin-top:10px}
    @media (max-width:1100px){.est{grid-template-columns:repeat(3,1fr)}}
    .out{margin-top:12px;font-size:14px}
    .out b{color:#fff}
    .badge{position:absolute;left:8px;top:8px;background:#0008;border:1px solid #fff2;padding:4px 8px;border-radius:8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Dati e prezzi da Spoolman (€/kg). Costo macchina fisso lato server. La stima usa CuraEngine.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce: <b>Materiale</b> — <span class="sub">Nome colore (HEX)</span> — <b>€/kg</b>. Aggiornamento ogni 60 s.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">
          <div class="badge">Trascina un file oppure usa “Carica / Da URL”</div>
          <div class="spinner" id="spin" style="display:none"><div class="spin"></div></div>
          <div id="threeMount" class="canvas-wrap" hidden></div>
          <div id="viewerFallback">In attesa di un modello…</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>File & Stima</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip" />
        <button id="btnUpload">Carica</button>
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="flex:1;min-width:260px" />
        <button id="btnFetch">Da URL</button>
      </div>

      <div class="est">
        <label>Layer
          <select id="layer_h">
            <option value="0.20">0.20 mm</option><option value="0.16">0.16 mm</option>
            <option value="0.12">0.12 mm</option><option value="0.28">0.28 mm</option>
          </select>
        </label>
        <label>Infill
          <select id="infill">
            <option value="15">15%</option><option value="5">5%</option>
            <option value="20">20%</option><option value="40">40%</option>
          </select>
        </label>
        <label>Nozzle
          <select id="nozzle">
            <option value="0.4">0.4 mm</option><option value="0.6">0.6 mm</option><option value="0.2">0.2 mm</option>
          </select>
        </label>
        <label>Print speed
          <select id="print_speed">
            <option value="60">60 mm/s</option><option value="80">80 mm/s</option><option value="40">40 mm/s</option>
          </select>
        </label>
        <label>Travel speed
          <select id="travel_speed">
            <option value="150">150 mm/s</option><option value="200">200 mm/s</option><option value="100">100 mm/s</option>
          </select>
        </label>
        <div style="display:flex;align-items:end">
          <button id="btnEstimate">Stima</button>
        </div>
      </div>

      <div id="out" class="out"></div>
    </div>
  </div>

  <script type="module">
    // ---------- util colore ----------
    function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f]{0,0})([a-f\d]{2})([a-f]{0,0})([a-f\d]{2})$/i.exec(hex||"");
      const k=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||""); const h=k||m;
      return h?{r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16)}:{r:127,g:127,b:127}; }
    const BASIC={"#000000":"Nero","#FFFFFF":"Bianco","#FF0000":"Rosso","#00FF00":"Verde",
      "#0000FF":"Blu","#FFFF00":"Giallo","#FFA500":"Arancione","#FFC0CB":"Rosa",
      "#800080":"Viola","#A52A2A":"Marrone","#808080":"Grigio","#00FFFF":"Ciano",
      "#008000":"Verde scuro","#ADD8E6":"Azzurro","#FFD700":"Oro","#8B4513":"Terra di Siena"};
    function nearestBasicName(hex){ const {r,g,b}=hexToRgb(hex), entries=Object.entries(BASIC);
      let best=entries[0][0], dist=1e9; for(const [h] of entries){ const c=hexToRgb(h);
      const d=(r-c.r)**2+(g-c.g)**2+(b-c.b)**2; if(d<dist){dist=d;best=h} } return BASIC[best]; }

    // ---------- stato ----------
    let selectedKey=null, currentViewerUrl=null;
    const REFRESH_MS=60000;

    // ---------- palette ----------
    async function loadPalette(){
      const res=await fetch('/inventory?nocache='+Date.now());
      const data=await res.json(); renderPalette(data.items||[]);
    }
    function renderPalette(items){
      const box=document.getElementById('palette'); box.innerHTML='';
      items.sort((a,b)=> (a.material||'').localeCompare(b.material||'') || (a.color||'').localeCompare(b.color||''))
      .forEach(it=>{
        const hex=(it.color||'#777777').toUpperCase();
        const price=(it.price_per_kg!=null)?`${it.price_per_kg.toFixed(2)} ${it.currency}/kg`:'n/d';
        const colorName=it.color_name||nearestBasicName(hex);
        const row=document.createElement('div'); row.className='pill'; row.setAttribute('role','option');
        row.setAttribute('aria-label',`${it.material}, ${colorName}, ${price}`);
        row.setAttribute('aria-selected',selectedKey===it.key?'true':'false');
        row.onclick=()=>{selectedKey=it.key;[...box.children].forEach(c=>c.setAttribute('aria-selected','false'));row.setAttribute('aria-selected','true');};
        const left=document.createElement('div'); left.className='left';
        const dot=document.createElement('span'); dot.className='dot'+(it.is_transparent?' transparent':'');
        if(!it.is_transparent){ dot.style.backgroundColor=hex; } dot.title=`${colorName} (${hex})`;
        const col=document.createElement('div'); const t1=document.createElement('div'); t1.className='title'; t1.textContent=it.material||'n/d';
        const t2=document.createElement('div'); t2.className='sub'; t2.textContent=`${colorName} (${hex})`;
        col.appendChild(t1); col.appendChild(t2); left.appendChild(dot); left.appendChild(col);
        const priceEl=document.createElement('div'); priceEl.className='price'; priceEl.textContent=price;
        row.appendChild(left); row.appendChild(priceEl); box.appendChild(row);
      });
    }

    // ---------- upload / fetch ----------
    async function uploadFileOrBlob(file){
      const fd=new FormData(); fd.append('file',file);
      const r=await fetch('/upload_model',{method:'POST',body:fd});
      if(!r.ok){ alert('Upload fallito'); return; }
      const j=await r.json(); showViewer(j.viewer_url, j.filename);
    }
    async function uploadFile(){ const f=document.getElementById('file').files[0];
      if(!f){alert('Seleziona un file');return;} uploadFileOrBlob(f); }
    async function fetchFromUrl(){
      const url=document.getElementById('url').value.trim(); if(!url){alert('Inserisci una URL');return;}
      const r=await fetch('/fetch_model',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
      const j=await r.json(); if(j.viewer_url){showViewer(j.viewer_url,j.filename);} else {alert('Nessun modello trovato');}
    }

    // ---------- viewer 3D ----------
    const viewer=document.getElementById('viewer');
    const threeMount=document.getElementById('threeMount');
    const spin=document.getElementById('spin');
    const fallbackEl=document.getElementById('viewerFallback');
    let threeCtx=null; // {THREE, renderer, scene, camera, controls, current}

    // drag & drop
    viewer.addEventListener('dragover', e=>{e.preventDefault(); viewer.classList.add('drag');});
    viewer.addEventListener('dragleave', ()=>viewer.classList.remove('drag'));
    viewer.addEventListener('drop', e=>{
      e.preventDefault(); viewer.classList.remove('drag');
      const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ uploadFileOrBlob(f); }
    });

    function showSpinner(on){ spin.style.display=on?'flex':'none'; }

    function fallbackLink(path, name){
      threeMount.hidden=true; fallbackEl.innerHTML =
        `Anteprima non disponibile. Apri il file: <a href="${path}" target="_blank" style="color:var(--accent)">${name||path}</a>`;
    }

    async function ensureThree(){
      if(threeCtx && threeCtx.THREE) return threeCtx;
      // Prova due CDN; in locale non serviamo i bundle per tenere l'immagine leggera.
      const base1='https://unpkg.com/three@0.160.0';
      const base2='https://cdn.jsdelivr.net/npm/three@0.160.0';
      async function tryLoad(base){
        const THREE = await import(`${base}/build/three.module.js`);
        const {OrbitControls} = await import(`${base}/examples/jsm/controls/OrbitControls.js`);
        const {STLLoader} = await import(`${base}/examples/jsm/loaders/STLLoader.js`);
        const {OBJLoader} = await import(`${base}/examples/jsm/loaders/OBJLoader.js`);
        const {ThreeMFLoader} = await import(`${base}/examples/jsm/loaders/3MFLoader.js`);
        return {THREE, OrbitControls, STLLoader, OBJLoader, ThreeMFLoader};
      }
      try { threeCtx = await tryLoad(base1); }
      catch(e1){ try { threeCtx = await tryLoad(base2); } catch(e2){ threeCtx=null; } }
      return threeCtx;
    }

    function fitCameraToObject(THREE, camera, object, controls){
      const box=new THREE.Box3().setFromObject(object);
      const size=box.getSize(new THREE.Vector3());
      const center=box.getCenter(new THREE.Vector3());
      const maxDim=Math.max(size.x,size.y,size.z);
      const fov=THREE.MathUtils.degToRad(camera.fov);
      let camZ=Math.abs(maxDim/2/Math.tan(fov/2));
      camZ*=1.35;
      camera.position.set(center.x+camZ, center.y+camZ*0.5, center.z+camZ);
      camera.near=maxDim/100; camera.far=maxDim*10; camera.updateProjectionMatrix();
      controls.target.copy(center); controls.update();
    }

    function initThree(THREE){
      const renderer=new THREE.WebGLRenderer({antialias:true, alpha:true});
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
      renderer.setSize(threeMount.clientWidth, threeMount.clientHeight);
      threeMount.innerHTML=''; threeMount.appendChild(renderer.domElement);
      const scene=new THREE.Scene();
      scene.background=null;
      const camera=new THREE.PerspectiveCamera(50, threeMount.clientWidth/threeMount.clientHeight,0.01,1000);
      const {OrbitControls}=threeCtx; const controls=new OrbitControls(camera, renderer.domElement);
      controls.enableDamping=true; controls.dampingFactor=0.05;
      const amb=new THREE.AmbientLight(0xffffff,0.8); scene.add(amb);
      const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(1,1,1); scene.add(dir);
      const grid=new THREE.GridHelper(200,20,0x334455,0x223344); grid.position.y=-0.001; scene.add(grid);
      const clock=new THREE.Clock();
      function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
      animate();
      window.addEventListener('resize', ()=>{
        const w=threeMount.clientWidth, h=threeMount.clientHeight;
        camera.aspect=w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h);
      });
      return {THREE, renderer, scene, camera, controls, current:null};
    }

    async function loadModel(path){
      showSpinner(true);
      const ctx=await ensureThree();
      if(!ctx){ showSpinner(false); fallbackLink(path, (path.split('/').pop())); return; }
      if(!threeCtx.renderer){ threeCtx = {...threeCtx, ...initThree(threeCtx.THREE)}; }
      const {THREE, scene, camera, controls}=threeCtx;

      // ripulisci precedente
      if(threeCtx.current){ scene.remove(threeCtx.current); threeCtx.current.traverse?.(o=>{ if(o.geometry) o.geometry.dispose(); if(o.material) (Array.isArray(o.material)?o.material:[o.material]).forEach(m=>m.dispose&&m.dispose()); }); threeCtx.current=null; }

      threeMount.hidden=false; fallbackEl.innerHTML='';
      const ext=(path.split('?')[0].split('#')[0].split('.').pop()||'').toLowerCase();
      const url=path; // stesso host => CORS ok

      try{
        let obj=null;
        if(ext==='stl'){
          const loader=new threeCtx.STLLoader(); const geo=await loader.loadAsync(url);
          const mat=new THREE.MeshStandardMaterial({color:0xaaaaaa, metalness:0.1, roughness:0.6});
          obj=new THREE.Mesh(geo, mat);
        } else if(ext==='obj'){
          const loader=new threeCtx.OBJLoader(); obj=await loader.loadAsync(url);
        } else if(ext==='3mf'){
          const loader=new threeCtx.ThreeMFLoader(); obj=await loader.loadAsync(url);
        } else {
          showSpinner(false); return fallbackLink(path);
        }
        // normalizza scala/origine
        obj.rotation.x = -Math.PI/2; // z-up -> y-up
        scene.add(obj); threeCtx.current=obj;
        fitCameraToObject(THREE, camera, obj, controls);
        showSpinner(false);
      }catch(e){
        console.error('Errore caricamento 3D', e);
        showSpinner(false); fallbackLink(path, (path.split('/').pop()));
      }
    }

    function showViewer(path, name){
      currentViewerUrl=path;
      loadModel(path);
      document.getElementById('out').innerHTML='';
    }

    async function estimate(){
      if(!currentViewerUrl){ alert('Carica prima un modello'); return; }
      if(!selectedKey){ alert('Seleziona un materiale dalla palette'); return; }
      const payload={ viewer_url:currentViewerUrl, inventory_key:selectedKey, settings:{
        layer_h:parseFloat(document.getElementById('layer_h').value),
        infill:parseFloat(document.getElementById('infill').value),
        nozzle:parseFloat(document.getElementById('nozzle').value),
        print_speed:parseFloat(document.getElementById('print_speed').value),
        travel_speed:parseFloat(document.getElementById('travel_speed').value)
      }};
      const r=await fetch('/slice/estimate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json(); if(!r.ok){ alert(j.detail||'Errore stima'); return; }
      const tmin=Math.round(j.time_s/60);
      document.getElementById('out').innerHTML =
        `Tempo: <b>${tmin} min</b> — Filamento: <b>${j.filament_g} g</b><br>
         Costo filamento: <b>${j.cost_filament} ${j.currency}</b> — Costo macchina: <b>${j.cost_machine} ${j.currency}</b><br>
         Totale: <b>${j.total} ${j.currency}</b> — <a href="${j.gcode_url}" target="_blank" style="color:var(--accent)">Scarica G-code</a>`;
    }

    // init
    document.getElementById('btnUpload').onclick=uploadFile;
    document.getElementById('btnFetch').onclick=fetchFromUrl;
    document.getElementById('btnEstimate').onclick=estimate;
    loadPalette(); setInterval(loadPalette, REFRESH_MS);
  </script>
</body>
</html>
