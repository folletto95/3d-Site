<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23fff' d='M12 50h40v4H12z'/%3E%3Crect x='16' y='10' width='32' height='36' rx='3' ry='3' fill='%23fff' stroke='%23000' stroke-width='2'/%3E%3Cpath d='M20 16h24M20 24h24M20 32h24M20 40h24' stroke='%23000' stroke-width='2'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#0f172a; --card:#172235; --ring:#263548;
      --text:#e8eef6; --muted:#93a4b8; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
    h1{margin:0;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .right{margin-left:auto}

    /* Palette */
    #palette{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto;padding-right:6px}
    .pill{display:flex;align-items:center;gap:14px;background:#0b172b40;border:1px solid #243244;border-radius:16px;padding:12px 14px}
    .pill[aria-selected="true"]{outline:2px solid var(--accent);background:#0b263c}
    .pill .title{font-weight:800}
    .pill .sub{color:var(--muted)}
    .pill .price{margin-left:auto;font-weight:800}
    .left{display:flex;align-items:center;gap:12px}
    .dot{
      width:26px;height:26px;border-radius:50%;
      border:2px solid rgba(255,255,255,.2);box-shadow:inset 0 0 0 2px rgba(0,0,0,.2);
      background:#666;
    }
    .dot.transparent{
      background:
        conic-gradient(#0000 90deg,#fff 0 180deg,#0000 0) 0 0/10px 10px,
        conic-gradient(#0000 90deg,#fff 0 180deg,#0000 0) 5px 5px/10px 10px,
        #fff;
    }

    .section-title{font-size:1.25rem;font-weight:800;margin-bottom:10px}
    .search{display:flex;align-items:center;background:#0b172b40;border:1px solid #243244;border-radius:12px;padding:10px 12px;margin-bottom:12px}
    .search input{all:unset;width:100%}

    #viewer{display:flex;align-items:center;justify-content:center;height:360px;border:1px dashed #2a3a52;border-radius:16px;color:#6e86a1}
    .btn{background:var(--accent);color:#001018;font-weight:800;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted-small{color:var(--muted);font-size:.9rem;margin-top:8px}
    code{background:#0c1626;padding:2px 4px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1>Magazzino Filamenti & Stima</h1>
      <div class="right">
        <button class="btn" onclick="reloadNow()">Aggiorna</button>
      </div>
    </div>
    <div class="muted">Dati da Spoolman (<code id="currency">EUR</code>, €/kg). La stima oraria è lato server.</div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <div class="section-title">Palette (seleziona materiale)</div>
        <div class="search"><input id="paletteFilter" placeholder="Filtra per materiale o colore" oninput="filterPalette()" /></div>
        <div id="palette" role="listbox" aria-label="Filamenti da Spoolman"></div>
        <div class="muted-small">Ogni voce: <b>Materiale</b> — <b>Nome colore</b> — <b>€/kg</b>. Aggiornamento periodico.</div>
      </div>

      <div class="card">
        <div class="section-title">Viewer 3D</div>
        <div id="viewer">Caricamento in arrivo. Trascina un file (STL/3MF/OBJ) o usa il pulsante sotto.</div>
        <div class="row" style="margin-top:10px">
          <input type="file" id="fileInput" />
          <button class="btn" disabled>Slice (coming)</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------
    // Config
    // -------------------------------
    const REFRESH_MS = 60000; // 60 s
    let items = [];
    let selectedKey = null;
    let colorOverrides = {}; // caricato da colors.json

    // -------------------------------
    // Colori: override + fallback HSV
    // -------------------------------
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec((hex||"").trim());
      if(!m) return {r:127,g:127,b:127};
      return {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)};
    }
    function classifyHSVName(hex){
      const h = (hex||"#777777").replace("#","");
      if(h.length!==6) return "Colore";

      const r = parseInt(h.slice(0,2),16)/255;
      const g = parseInt(h.slice(2,4),16)/255;
      const b = parseInt(h.slice(4,6),16)/255;

      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const v = max;
      const d = max - min;
      const s = max===0 ? 0 : d/max;
      let hh = 0;
      if(d!==0){
        switch(max){
          case r: hh = ((g-b)/d + (g<b?6:0)); break;
          case g: hh = ((b-r)/d + 2); break;
          case b: hh = ((r-g)/d + 4); break;
        }
        hh *= 60;
      }

      if(s < 0.08){
        if(v < 0.12) return "Nero";
        if(v > 0.88) return "Bianco";
        return "Grigio";
      }

      // Oro PRIMA di Arancione
      if(hh >= 40 && hh < 55 && s > 0.40 && v > 0.60) return "Oro";

      // Rosa / Fucsia
      if((hh >= 295 && hh < 350) || (hh >= 350 && s < 0.20 && v > 0.85)) return "Rosa";
      if(hh >= 10 && hh < 40 && s < 0.20 && v > 0.85) return "Rosa";

      if(hh < 10 || hh >= 350) return "Rosso";
      if(hh >= 10 && hh < 40) return "Arancione";
      if(hh >= 55 && hh < 65) return "Giallo";
      if(hh >= 65 && hh < 170) return "Verde";
      if(hh >= 170 && hh < 190) return "Ciano";
      if(hh >= 190 && hh < 255) return "Blu";
      if(hh >= 255 && hh < 295) return "Viola";

      return "Colore";
    }
    function nameFor(hex, isTransparent, apiName){
      if(isTransparent) return "Trasparente";
      const H = (hex||"").toUpperCase();
      if(apiName && apiName.trim()) return apiName;               // preferisci nome di Spoolman se presente
      if(colorOverrides[H]) return colorOverrides[H];             // override esterni
      return classifyHSVName(H);                                  // fallback HSV
    }

    // -------------------------------
    // Render palette
    // -------------------------------
    function render(list){
      const box = document.getElementById("palette");
      box.innerHTML = "";

      list
        .slice()
        .sort((a,b)=> (a.material||"").localeCompare(b.material||"") || (a.color_hex||"").localeCompare(b.color_hex||""))
        .forEach((it, idx)=>{
          const hex = (it.color_hex || "#777777").toUpperCase();
          const isTr = !!it.is_transparent;
          const label = nameFor(hex, isTr, it.color_name);
          const price = (it.price_per_kg!=null) ? `${it.price_per_kg.toFixed(2)} ${it.currency}/kg` : "n/d";
          const key = `${it.material}|${hex}|${it.diameter}|${isTr}|${label}|${idx}`;

          const row = document.createElement("div");
          row.className = "pill";
          row.setAttribute("role","option");
          row.setAttribute("aria-selected", selectedKey===key ? "true" : "false");
          row.onclick = ()=>{ selectedKey = key; render(list); };

          const left = document.createElement("div");
          left.className = "left";

          const dot = document.createElement("span");
          dot.className = "dot" + (isTr ? " transparent" : "");
          if(!isTr){ dot.style.backgroundColor = hex; }

          const col = document.createElement("div");
          const t1 = document.createElement("div");
          t1.className = "title";
          t1.textContent = it.material || "N/D";

          const t2 = document.createElement("div");
          t2.className = "sub";
          t2.textContent = label + (isTr ? "" : ` (${hex})`);

          col.appendChild(t1);
          col.appendChild(t2);

          const priceEl = document.createElement("div");
          priceEl.className = "price";
          priceEl.textContent = price;

          left.appendChild(dot);
          left.appendChild(col);

          row.appendChild(left);
          row.appendChild(priceEl);

          box.appendChild(row);
        });
    }

    function filterPalette(){
      const q = (document.getElementById("paletteFilter").value || "").trim().toLowerCase();
      if(!q){ render(items); return; }
      const f = items.filter(it=>{
        const name = nameFor(it.color_hex, it.is_transparent, it.color_name).toLowerCase();
        const mat  = (it.material||"").toLowerCase();
        return name.includes(q) || mat.includes(q);
      });
      render(f);
    }
    function reloadNow(){ loadAll(true); }

    async function loadColors(){
      try{
        const res = await fetch("./colors.json", {cache:"no-cache"});
        if(res.ok){
          colorOverrides = await res.json();
        } else {
          colorOverrides = {};
        }
      }catch{ colorOverrides = {}; }
    }

    async function loadInventory(){
      const url = `/api/spools?nocache=${Date.now()}`;
      const res = await fetch(url, {cache:"no-cache"});
      if(!res.ok){
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      document.getElementById("currency").textContent = data.currency || "EUR";
      return Array.isArray(data.items) ? data.items : [];
    }

    async function loadAll(force){
      try{
        if(force) await loadColors();
        items = await loadInventory();
        render(items);
      }catch(e){
        const box = document.getElementById("palette");
        box.innerHTML = `<div class="muted">Errore caricamento: <code>${String(e)}</code></div>`;
      }
    }

    // Avvio
    (async ()=>{
      await loadColors();
      await loadAll(false);
      setInterval(()=>loadAll(false), REFRESH_MS);
    })();
  </script>
</body>
</html>
