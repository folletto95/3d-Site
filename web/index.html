<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazzino Filamenti & Stima</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ðŸ§µ</text></svg>">
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--muted:#94a3b8;--text:#e2e8f0;--ring:#334155;--accent:#38bdf8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:18px;border:1px solid var(--ring)}
    h1{margin:0 0 12px;font-size:28px}
    h2{margin:0 0 12px;font-size:18px}
    .palette{display:flex;flex-direction:column;gap:6px;max-height:360px;overflow:auto;padding-right:6px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-radius:14px;background:#0b1527;border:1px solid var(--ring);cursor:pointer;font-size:14px}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .pill[aria-selected="true"]{outline:2px solid var(--accent)}
    .left{display:flex;align-items:center;gap:12px}
    .dot{width:18px;height:18px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
    .dot.transparent{
      background-image:
        linear-gradient(45deg,#999 25%,transparent 25%),
        linear-gradient(-45deg,#999 25%,transparent 25%),
        linear-gradient(45deg,transparent 75%,#999 75%),
        linear-gradient(-45deg,transparent 75%,#999 75%);
      background-size:8px 8px;
      background-position:0 0,0 4px,4px -4px,-4px 0;
      background-color:#fff;
    }
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .price{font-weight:800}
    .row{display:flex;gap:12px;align-items:center}
    input[type="file"],input[type="text"],select,button{border-radius:10px;border:1px solid var(--ring);background:#0b1527;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px}
    .viewer{height:460px;border-radius:16px;border:1px dashed var(--ring);display:flex;align-items:center;justify-content:center;color:var(--muted)}
    .viewer.drag{border-color:var(--accent); color:var(--accent)}
    .est{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:10px;margin-top:10px}
    @media (max-width:1100px){.est{grid-template-columns:repeat(3,1fr)}}
    .out{margin-top:20px;font-size:18px;line-height:1.5;background:#0b1527;padding:12px;border-radius:10px;color:var(--text)}
    .out b{color:var(--accent);font-size:20px}
    .advanced { display: none; }
  </style>

  <!-- Import map per Three r160+ (DEVE stare nel <head> prima dei moduli) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>

</head>
<body>
  <div class="wrap">
    <h1>Magazzino Filamenti & Stima</h1>
    <p class="hint">Ciao, qui puoi caricare un modello e stimare i costi col materiele che preferisci buon divertimento.</p>

    <div class="grid">
      <div class="card">
        <h2>Palette (seleziona materiale)</h2>
        <input id="paletteFilter" type="text" placeholder="Filtra per materiale o colore" style="margin-bottom:8px; width:100%" />
        <div id="palette" class="palette" role="listbox" aria-label="Seleziona materiale e colore per la stima"></div>
        <p class="hint">Ogni voce: <b>Materiale</b> â€” <span class="sub">Nome colore</span> â€” <b>â‚¬/kg</b>. Aggiornamento ogni 60 s.</p>
      </div>

      <div class="card">
        <h2>Viewer 3D (STL/3MF/OBJ)</h2>
        <div id="viewer" class="viewer" aria-live="polite">Trascina qui un file o caricalo dal pulsante sotto.</div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>File & Stima</h2>
      <div class="row" style="flex-wrap:wrap">
        <input id="file" type="file" accept=".stl,.obj,.3mf,.zip,.step,.stp" multiple />
        <input id="url" type="text" placeholder="https://www.thingiverse.com/thing:..." style="flex:1;min-width:260px" />
        <button id="btnFetch">Da URL</button>
        <button id="btnDelete" style="margin-left:8px">Elimina</button>
      </div>

      <div class="est">
        <label class="advanced">Layer
          <select id="layer_h">
            <option value="0.20">0.20 mm</option>
            <option value="0.16">0.16 mm</option>
            <option value="0.12">0.12 mm</option>
            <option value="0.28">0.28 mm</option>
          </select>
        </label>
        <label class="advanced">Infill
          <select id="infill">
            <option value="15">15%</option>
            <option value="5">5%</option>
            <option value="20">20%</option>
            <option value="40">40%</option>
          </select>
        </label>
        <label class="advanced">Nozzle
          <select id="nozzle">
            <option value="0.4">0.4 mm</option>
            <option value="0.6">0.6 mm</option>
            <option value="0.2">0.2 mm</option>
          </select>
        </label>
        <label class="advanced">Print speed
          <select id="print_speed">
            <option value="40">40 mm/s</option>
            <option value="60" selected>60 mm/s</option>
            <option value="80">80 mm/s</option>
            <option value="100">100 mm/s</option>
            <option value="160">160 mm/s</option>
            <option value="200">200 mm/s</option>
            <option value="250">250 mm/s</option>
          </select>
        </label>
        <label class="advanced">Travel speed
          <select id="travel_speed">
            <option value="100">100 mm/s</option>
            <option value="150" selected>150 mm/s</option>
            <option value="200">200 mm/s</option>
            <option value="300">300 mm/s</option>
            <option value="500">500 mm/s</option>
          </select>
        </label>
        <label>Preset
          <select id="preset">
            <option value="x1c_standard_020" selected>Standard</option>
            <optgroup label="Bambu X1C">
              <option value="x1c_standard_020">0.20 Standard</option>
              <option value="x1c_quality_016">0.16 Quality</option>
              <option value="x1c_fine_012">0.12 Fine</option>
              <option value="x1c_draft_028">0.28 Draft</option>
              <option value="x1c_strength_020">0.20 Strength</option>
              <option value="x1c_lightning_020">0.20 Lightning</option>
              <option value="x1c_ultrafine_008">0.08 Ultra Fine</option>
            </optgroup>
          </select>
        </label>
        <div style="display:flex;align-items:end">
          <button id="btnEstimate">Stima</button>
        </div>
      </div>

      <div id="out" class="out"></div>
    </div>
  </div>

  <button id="btnWizard" title="Apri guida" style="position:fixed;top:16px;right:16px;background:var(--card);border:1px solid var(--ring);color:var(--accent);padding:8px 12px;border-radius:12px;font-size:14px;z-index:1000;cursor:pointer">Guida</button>

  <div id="wizard" class="wizard-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;">
    <div class="wizard-box" style="max-width:600px;margin:10% auto;background:var(--card);color:var(--text);padding:24px;border-radius:16px;box-shadow:0 0 12px rgba(0,0,0,0.5);">
      <h2 style="margin-top:0">Benvenuto!</h2>
      <p>Questa guida ti accompagna ai passi per ottenere una stima:</p>
      <ol style="line-height:1.6">
        <li><b>Scegli un materiale</b> dalla palette.</li>
        <li><b>Carica il modello</b> (STL/3MF/OBJ o URL).</li>
        <li><b>Scegli il preset</b> (X1C di default).</li>
        <li><b>Premi Stima</b> per G-code, tempi e costi.</li>
      </ol>
      <p style="margin-top:20px;text-align:right"><button id="wizardClose" style="background:var(--accent);color:#000;padding:8px 16px;border:none;border-radius:10px;cursor:pointer">Chiudi</button></p>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>

</body>
</html>
